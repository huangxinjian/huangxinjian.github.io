(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{242:function(s,t,a){"use strict";a.r(t);var e=a(28),n=Object(e.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"mysql-锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql-锁"}},[s._v("#")]),s._v(" MySQL 锁")]),s._v(" "),a("p",[s._v("MySQL 锁是实现事务的关键，因此需要学习 MySQL 的锁。")]),s._v(" "),a("h2",{attrs:{id:"mysql-锁种类"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql-锁种类"}},[s._v("#")]),s._v(" MySQL 锁种类")]),s._v(" "),a("p",[s._v("在 MySQL 中，锁的种类图如下：")]),s._v(" "),a("p",[a("img",{attrs:{src:"/mysql_img/locksort.jpg",alt:"lock"}})]),s._v(" "),a("p",[s._v("重点讲解一下悲观锁中的表锁与行锁，乐观锁留在 "),a("code",[s._v("Redis")]),s._v(" 讲解")]),s._v(" "),a("h2",{attrs:{id:"表级锁种类"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#表级锁种类"}},[s._v("#")]),s._v(" 表级锁种类")]),s._v(" "),a("p",[s._v("由图示可以看到，MySQL 表锁有三种：")]),s._v(" "),a("ul",[a("li",[s._v("表锁")]),s._v(" "),a("li",[s._v("元数据（MDL）锁")]),s._v(" "),a("li",[s._v("意向锁")])]),s._v(" "),a("p",[s._v("其中，表锁和元数据锁都是 MySQL Layer 层提供的， 意向锁是由 InnoDB 提供的。")]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),a("p",[s._v("首先需要明确一点的是，锁只是一种状态，共享读不是读，加了共享读锁的话，别的事务就不能对这个数据再加排它写锁。")])]),s._v(" "),a("h3",{attrs:{id:"查看锁表情况"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查看锁表情况"}},[s._v("#")]),s._v(" 查看锁表情况")]),s._v(" "),a("p",[s._v("可以通过 "),a("code",[s._v("show status like 'table%';")]),s._v(" 来查看当前数据库中发生过多少次锁表现象")]),s._v(" "),a("p",[a("img",{attrs:{src:"/mysql_img/checklock.png",alt:"lock"}})]),s._v(" "),a("p",[s._v("其中：")]),s._v(" "),a("ul",[a("li",[s._v("table_locks_immediate：产生表级锁定的次数；")]),s._v(" "),a("li",[s._v("table_locks_waited：出现表级锁定争用而发生等待的次数")])]),s._v(" "),a("h2",{attrs:{id:"表级锁之表锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#表级锁之表锁"}},[s._v("#")]),s._v(" 表级锁之表锁")]),s._v(" "),a("h3",{attrs:{id:"表锁的表现形式"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#表锁的表现形式"}},[s._v("#")]),s._v(" 表锁的表现形式")]),s._v(" "),a("p",[s._v("表锁一共分为两种表现形式，分别是：")]),s._v(" "),a("ul",[a("li",[s._v("表共享读锁（Table Read Lock）")]),s._v(" "),a("li",[s._v("表独占写锁（Table Write Lock）")])]),s._v(" "),a("h3",{attrs:{id:"表锁的添加删除和查看"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#表锁的添加删除和查看"}},[s._v("#")]),s._v(" 表锁的添加删除和查看")]),s._v(" "),a("p",[s._v("表锁是要手动添加的一种表级锁，通过关键字 "),a("code",[s._v("lock table 表名称 read(write),表名称2 read(write)")]),s._v(" 添加读、写锁。")]),s._v(" "),a("p",[s._v("如果想要查看表锁，可以通过 "),a("code",[s._v("show open tables;")]),s._v(" 进行查看")]),s._v(" "),a("p",[s._v("如果想要删除表锁，可以通过 "),a("code",[s._v("unlock tables;")])]),s._v(" "),a("h3",{attrs:{id:"表锁演示"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#表锁演示"}},[s._v("#")]),s._v(" 表锁演示")]),s._v(" "),a("p",[s._v("准备工作：")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--新建表")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CREATE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("TABLE")]),s._v(" mylock "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("\nid "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("NOT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AUTO_INCREMENT")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\nNAME "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("varchar")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DEFAULT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("NULL")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("PRIMARY")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("KEY")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INSERT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INTO")]),s._v(" mylock "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VALUES")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'a'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INSERT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INTO")]),s._v(" mylock "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VALUES")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'b'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INSERT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INTO")]),s._v(" mylock "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VALUES")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'c'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INSERT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INTO")]),s._v(" mylock "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("VALUES")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'d'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[a("strong",[s._v("演示读锁：")])]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("、session1: "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("lock")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" mylock "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("read")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 给mylock表加读锁")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("、session1: "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" mylock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 可以查询")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("、session1："),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" tdep"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 不能访问非锁定表")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("、session2："),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" mylock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 可以查询 没有锁")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("、session2："),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" mylock "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'x'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 修改阻塞,自动加行写锁")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("、session1："),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("unlock")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("tables")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 释放表锁")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("、session2："),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("Rows")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("matched")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" Changed: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("Warnings")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 修改执行完成")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("、session1："),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" tdep"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--可以访问")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("加了读锁，"),a("code",[s._v("session 1")]),s._v(" 只能对锁住的表进行读，不能写，也不能读其它的表，"),a("code",[s._v("session 2")]),s._v(" 可以读 "),a("code",[s._v("session 1")]),s._v(" 锁住的表，但是不能写。因为写操作会自动加排他写锁，而排他写于共享读是冲突的。")]),s._v(" "),a("p",[a("strong",[s._v("演示写锁")]),s._v(":")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("、session1: "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("lock")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" mylock "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("write")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 给mylock表加写锁")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("、session1: "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" mylock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 可以查询")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("、session1："),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" tdep"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--不能访问非锁定表")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("、session1："),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" mylock "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'y'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--可以执行")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("、session2："),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" mylock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 查询阻塞")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),s._v("、session1："),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("unlock")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("tables")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 释放表锁")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),s._v("、session2："),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("rows")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("22.57")]),s._v(" sec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 查询执行完成")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),s._v("、session1："),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" tdep"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--可以访问")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("加了写锁，"),a("code",[s._v("session 1")]),s._v(" 可以对锁住的表进行读或写，"),a("code",[s._v("session 2")]),s._v(" 对 "),a("code",[s._v("session 1")]),s._v(" 锁住的表，读都不能读，也就是说，表级的写锁是独享状态的，不与任何其它 session 分享。")]),s._v(" "),a("h2",{attrs:{id:"表级锁之mdl锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#表级锁之mdl锁"}},[s._v("#")]),s._v(" 表级锁之MDL锁")]),s._v(" "),a("p",[a("code",[s._v("MDL")]),s._v("锁又称为元数据锁，是一种"),a("strong",{staticStyle:{color:"#3EAF7C"}},[s._v("用来保护表结构的锁")]),s._v("。它也分为两种表现形式：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("MDL")]),s._v(" 读锁")]),s._v(" "),a("li",[a("code",[s._v("MDL")]),s._v(" 写锁")])]),s._v(" "),a("p",[s._v("其中，"),a("strong",{staticStyle:{color:"#3EAF7C"}},[s._v("当执行 "),a("code",[s._v("DML")]),s._v(" 语句的时候，会自动添加 "),a("code",[s._v("MDL")]),s._v(" 读锁，当执行 "),a("code",[s._v("DDL")]),s._v(" 语句修改表结构的时候，会自动添加 "),a("code",[s._v("MDL")]),s._v(" 写锁")]),s._v("，也就是说，当我们在更新数据的时候，"),a("code",[s._v("DDL")]),s._v(" 语句由于获取不到 "),a("code",[s._v("MDL")]),s._v(" 写锁，所以是无法执行的。又当我们在执行 "),a("code",[s._v("DDL")]),s._v(" 语句的时候，会添加 "),a("code",[s._v("MDL")]),s._v(" 写锁，因此如果想要执行 "),a("code",[s._v("DML")]),s._v(" 语句时，由于无法获取到 "),a("code",[s._v("DML")]),s._v(" 读锁，也是无法执行的。")]),s._v(" "),a("p",[s._v("这样就能够保证表结构在 CRUD 的时候不被影响。")]),s._v(" "),a("h3",{attrs:{id:"mdl锁演示"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mdl锁演示"}},[s._v("#")]),s._v(" MDL锁演示")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("、session1: "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("begin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--开启事务")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" mylock"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--加MDL读锁")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("、session2: "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("alter")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" mylock "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("add")]),s._v(" f "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 修改阻塞")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("、session1："),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("commit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--提交事务 或者 rollback 释放读锁")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("、session2：Query OK"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("rows")]),s._v(" affected "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("38.67")]),s._v(" sec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--修改完成")]),s._v("\n Records: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" Duplicates: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("Warnings")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("h2",{attrs:{id:"表级锁之意向锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#表级锁之意向锁"}},[s._v("#")]),s._v(" 表级锁之意向锁")]),s._v(" "),a("p",[s._v("意向锁是由存储引擎 "),a("code",[s._v("InnoDB")]),s._v(" 实现的一种"),a("strong",{staticStyle:{color:"#3EAF7C"}},[s._v("为了全表更新数据时的性能提升")]),s._v("的表级锁，它由 MySQL 控制，不需要人为的去操控这个锁，它同样分为两种：")]),s._v(" "),a("ul",[a("li",[s._v("意向共享读（IS）：当打算给某一行数据添加一个"),a("strong",[s._v("行级别的共享读锁")]),s._v("时，需要先获取到这个表的 "),a("code",[s._v("IS")]),s._v(" 锁才可以")]),s._v(" "),a("li",[s._v("意向排他写（IX）：当打算给某一行数据添加一个"),a("strong",[s._v("行级别的排他写锁")]),s._v("时，需要先获取到这个表的 "),a("code",[s._v("IX")]),s._v(" 锁才可以")])]),s._v(" "),a("h3",{attrs:{id:"意向锁解决的问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#意向锁解决的问题"}},[s._v("#")]),s._v(" 意向锁解决的问题")]),s._v(" "),a("p",[s._v("为什么要存在意向锁这么一个东西呢？先来看这样一个场景，假设现在 "),a("code",[s._v("Session A")]),s._v(" 现在给 "),a("code",[s._v("user")]),s._v(" 表中的某一行记录添加了一个 "),a("code",[s._v("行锁")]),s._v("，此时 "),a("code",[s._v("Session B")]),s._v(" 想要给 "),a("code",[s._v("user")]),s._v(" 表加一个表级 "),a("code",[s._v("X")]),s._v(" 锁来批量修改数据，此时只有两种获取到表锁的机会：")]),s._v(" "),a("ul",[a("li",[s._v("判断表是否已被其他事务用表锁锁表")]),s._v(" "),a("li",[s._v("逐行判断这个表中是否有哪一行被其他事物用行锁锁住")])]),s._v(" "),a("p",[s._v("可以看到，第一种方式很容易就能判断出来，但是第二种方式要如何判断出是否有行锁呢？因此，InnoDB 引入了意向锁的概念，"),a("strong",{staticStyle:{color:"#3EAF7C"}},[s._v("它规定了，当事务想要对表中记录添加行读/写锁之前，必须先申请到该表的意向读/写锁。")])]),s._v(" "),a("p",[s._v("例如，"),a("code",[s._v("Session A")]),s._v(" 现在想要给 "),a("code",[s._v("user")]),s._v(" 表中的某一行记录添加 "),a("code",[s._v("行锁")]),s._v("，如果添加的是"),a("code",[s._v("行写锁")]),s._v("，则需要先申请到 "),a("code",[s._v("user")]),s._v(" 的"),a("code",[s._v("意向排他写锁")]),s._v("，如果添加的是"),a("code",[s._v("行读锁")]),s._v("，则需要先申请到 "),a("code",[s._v("意向共享读锁")]),s._v("。")]),s._v(" "),a("p",[s._v("这样，当 "),a("code",[s._v("Session B")]),s._v(" 想要对 "),a("code",[s._v("user")]),s._v(" 添加表级锁的时候，就可以先判断这个表当前是否存在 "),a("code",[s._v("意向锁")]),s._v(" ，就可以知道现在表中是否有记录被添加了 "),a("code",[s._v("行锁")]),s._v(" 了。")]),s._v(" "),a("h3",{attrs:{id:"意向锁兼容图"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#意向锁兼容图"}},[s._v("#")]),s._v(" 意向锁兼容图")]),s._v(" "),a("p",[s._v("这里是意向锁与"),a("strong",[s._v("表级锁")]),s._v("之间的兼容图。")]),s._v(" "),a("p",[a("img",{attrs:{src:"/mysql_img/yixiangsuo.jpg",alt:"img"}})]),s._v(" "),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[s._v("注意")]),s._v(" "),a("p",[s._v("注意，意向锁与行锁之间是没有冲突关系的，只是与表锁存在冲突关系。即 "),a("code",[s._v("IX")]),s._v("，"),a("code",[s._v("IS")]),s._v("是表级锁，不会和行级的"),a("code",[s._v("X")]),s._v("，"),a("code",[s._v("S")]),s._v("锁发生冲突。只会和表级的"),a("code",[s._v("X")]),s._v("，"),a("code",[s._v("S")]),s._v("发生冲突")])]),s._v(" "),a("h2",{attrs:{id:"行级锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#行级锁"}},[s._v("#")]),s._v(" 行级锁")]),s._v(" "),a("p",[s._v("行级锁是在存储引擎层实现的一种粒度更小的锁，它是为了并发而存在的，以前在使用 "),a("code",[s._v("MyISAM")]),s._v(" 存储引擎的时候，并不支持行级锁，因此如果想要做并发只能通过表级锁，换句话说，"),a("strong",{staticStyle:{color:"#3EAF7C"}},[s._v("使用表级锁做并发就意味着同一时刻只能有一条 "),a("code",[s._v("DML")]),s._v(" 语句在执行，其他的都得等待这个语句执行完成后才能执行")]),s._v("。")]),s._v(" "),a("p",[s._v("另外，行锁是通过给"),a("strong",{staticStyle:{color:"#3EAF7C"}},[s._v("索引上的索引项")]),s._v("加锁来实现的。这就意味着，只有通过索引进行条件检索的数据，"),a("code",[s._v("innodb")]),s._v(" 才会给它加上行锁，否则将会升级为表锁！！！")]),s._v(" "),a("p",[s._v("因此 "),a("code",[s._v("InnoDB")]),s._v(" 开发了行级锁，行级锁按照锁定范围区分，可以划分为三种：")]),s._v(" "),a("ul",[a("li",[s._v("记录锁(Record Lock)，锁定表中的某一条记录, "),a("strong",{staticStyle:{color:"#3EAF7C"}},[s._v("通常由等值主键条件产生")])]),s._v(" "),a("li",[s._v("间隙锁（Gap Lock），锁定记录前、记录中、记录后的行 ，"),a("strong",{staticStyle:{color:"#3EAF7C"}},[s._v("只在Mysql默认隔离级别RR下存在")])]),s._v(" "),a("li",[s._v("Next Key锁: 记录锁 + 间隙锁")])]),s._v(" "),a("p",[s._v("按照功能划分的话，可以划分为两种：")]),s._v(" "),a("ul",[a("li",[s._v("共享读锁")]),s._v(" "),a("li",[s._v("排它写锁")])]),s._v(" "),a("h3",{attrs:{id:"共享读和排他写"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#共享读和排他写"}},[s._v("#")]),s._v(" 共享读和排他写")]),s._v(" "),a("p",[s._v("共享锁(S锁)又称读锁，若事务"),a("code",[s._v("T")]),s._v("对数据对象"),a("code",[s._v("A")]),s._v("加上"),a("code",[s._v("S")]),s._v("锁，则事务"),a("code",[s._v("T")]),s._v("可以读"),a("code",[s._v("A")]),s._v("但不能修改"),a("code",[s._v("A")]),s._v("，其他事务只能再对"),a("code",[s._v("A")]),s._v("加"),a("code",[s._v("S")]),s._v("锁，而不能加"),a("code",[s._v("X")]),s._v("锁，直到"),a("code",[s._v("T")]),s._v("释放"),a("code",[s._v("A")]),s._v("上的"),a("code",[s._v("S")]),s._v(" 锁。这保证了其他事务可以读"),a("code",[s._v("A")]),s._v("，但在"),a("code",[s._v("T")]),s._v("释放"),a("code",[s._v("A")]),s._v("上的"),a("code",[s._v("S")]),s._v("锁之前不能对"),a("code",[s._v("A")]),s._v("做任何修改。")]),s._v(" "),a("p",[s._v("排他锁(X锁)又称写锁。若事务"),a("code",[s._v("T")]),s._v("对数据对象"),a("code",[s._v("A")]),s._v("加上"),a("code",[s._v("X")]),s._v("锁，事务"),a("code",[s._v("T")]),s._v("可以读"),a("code",[s._v("A")]),s._v("也可以修改"),a("code",[s._v("A")]),s._v("，其他事务不能再对"),a("code",[s._v("A")]),s._v("加任何锁，直到"),a("code",[s._v("T")]),s._v("释放"),a("code",[s._v("A")]),s._v("上的锁。这保证了其他事务在"),a("code",[s._v("T")]),s._v("释放"),a("code",[s._v("A")]),s._v("上的锁之前不能再读取和修改"),a("code",[s._v("A")]),s._v("。")]),s._v(" "),a("h3",{attrs:{id:"添加行锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#添加行锁"}},[s._v("#")]),s._v(" 添加行锁")]),s._v(" "),a("h4",{attrs:{id:"添加共享读锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#添加共享读锁"}},[s._v("#")]),s._v(" 添加共享读锁")]),s._v(" "),a("p",[s._v("共享读锁需要通过手动添加的方式来添加，当添加了共享读锁后，"),a("strong",{staticStyle:{color:"#3EAF7C"}},[s._v("允许一个事务去读取一行记录，同时防止别的事务去添加排他写锁，对其进行更新操作")]),s._v("。")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" table_name "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("LOCK")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("IN")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SHARE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("MODE")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 共享读锁 手动添加")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 无锁")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br")])]),a("h4",{attrs:{id:"添加排他写锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#添加排他写锁"}},[s._v("#")]),s._v(" 添加排他写锁")]),s._v(" "),a("p",[s._v("排他写锁允许获得该锁的事务对记录进行读取或修改，同时防止其它事务对其添加读锁或写锁")]),s._v(" "),a("div",{staticClass:"custom-block danger"},[a("p",{staticClass:"custom-block-title"},[s._v("注意")]),s._v(" "),a("p",[s._v("这里是防止其它事务对其添加读锁，并不是防止其它事务读取该条记录，读锁并不是读。")])]),s._v(" "),a("p",[s._v("它有两种添加方式，一种是自动添加，另一种是手动添加：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("DML")]),s._v(" 语句会自动添加排他写锁")]),s._v(" "),a("li",[s._v("手动添加则通过关键字 "),a("code",[s._v("FOR UPDATE")]),s._v(" 表示添加的是一个排他写锁")])]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" table_name "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FOR")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("UPDATE")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("h3",{attrs:{id:"查看行锁状态"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查看行锁状态"}},[s._v("#")]),s._v(" 查看行锁状态")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("show")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("STATUS")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("like")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'innodb_row_lock%'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("几个指标的含义：")]),s._v(" "),a("ul",[a("li",[s._v("Innodb_row_lock_current_waits：当前正在等待锁定的数量；")]),s._v(" "),a("li",[s._v("Innodb_row_lock_time：从系统启动到现在锁定总时间长度；")]),s._v(" "),a("li",[s._v("Innodb_row_lock_time_avg：每次等待所花平均时间；")]),s._v(" "),a("li",[s._v("Innodb_row_lock_time_max：从系统启动到现在等待最常的一次所花的时间；")]),s._v(" "),a("li",[s._v("Innodb_row_lock_waits：系统启动后到现在总共等待的次数；")])]),s._v(" "),a("h3",{attrs:{id:"两阶段锁提交"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#两阶段锁提交"}},[s._v("#")]),s._v(" 两阶段锁提交")]),s._v(" "),a("p",[s._v("两阶段提交指的是，在一个事务中，处于加锁阶段时，只会加锁，等到事务提交后，进入解锁阶段，才会开始解锁。例如：")]),s._v(" "),a("p",[a("img",{attrs:{src:"/mysql_img/2pc.png",alt:"img"}})]),s._v(" "),a("p",[s._v("在这里，A 会给 "),a("code",[s._v("id=1/2")]),s._v(" 的记录都加上锁，因此 B 会被阻塞，直到 A 提交了事务，锁才被释放。")]),s._v(" "),a("p",[s._v("那么，两阶段提交这样子做有什么意义呢？目前我们知道了，在一个事务中，只不要提交事务，所加的锁都不会被释放，会一直被持有。设想下面这个场景：顾客 "),a("code",[s._v("userA")]),s._v(" 要在影院购买电影票，需要涉及以下操作：")]),s._v(" "),a("ol",[a("li",[s._v("扣除顾客 userA 账户余额")]),s._v(" "),a("li",[s._v("增加影院 cinema 账户余额")]),s._v(" "),a("li",[s._v("记录一条交易日志")])]),s._v(" "),a("p",[s._v("也就是说，完成这个交易，涉及到两个 "),a("code",[s._v("update")]),s._v(" 和一个 "),a("code",[s._v("insert")]),s._v("，需要加三个行写锁。并且为了保证事务的原子性，我们必须将这三个操作放在一个事务中，换句话说，当我们提交这个事务之前，根据两阶段锁协议，这三个锁都不会被释放。")]),s._v(" "),a("p",[s._v("假设现在顾客 "),a("code",[s._v("userB")]),s._v(" 也要在影院购买电影票，这三个步骤同样也是需要加锁执行的，因此对于步骤2增加影院余额来说，两个事务就会发生等待锁的操作。因此可以利用两阶段锁，来降低事务等待锁的时间，因为无论怎么对三个步骤排序，锁都是会加上的，所以"),a("strong",{staticStyle:{color:"#3EAF7C"}},[s._v("尽量让最可能造成锁冲突的、最可能影响并发度的锁往后放")]),s._v("，即将步骤2放在事务的最后一步再做，图示如下：")]),s._v(" "),a("p",[a("img",{attrs:{src:"/mysql_img/2pcdemo.jpg",alt:"/mysql_img/"}})]),s._v(" "),a("p",[s._v("如果将"),a("code",[s._v("步骤2")]),s._v("放在最前面，则 "),a("code",[s._v("userB")]),s._v(" 需要等待一整个 "),a("code",[s._v("userA")]),s._v(" 的事务结束才能获取到锁。")]),s._v(" "),a("h2",{attrs:{id:"行级锁演示"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#行级锁演示"}},[s._v("#")]),s._v(" 行级锁演示")]),s._v(" "),a("p",[s._v("下面分别演示一下行锁的几种情况：")]),s._v(" "),a("ul",[a("li",[s._v("行读锁")]),s._v(" "),a("li",[s._v("行写锁")]),s._v(" "),a("li",[s._v("行读锁升级表锁")])]),s._v(" "),a("h3",{attrs:{id:"行读锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#行读锁"}},[s._v("#")]),s._v(" 行读锁")]),s._v(" "),a("p",[s._v("注意这里加锁的时候，使用的索引是主键索引")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("、session1: "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("begin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--开启事务未提交")]),s._v("\n             "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" mylock  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" ID"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("lock")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("share")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("mode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--手动加id=1的行读锁,使用索引")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("、session2："),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" mylock "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'y'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 未锁定该行可以修改")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("、session2："),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" mylock "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'y'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 锁定该行修改阻塞")]),s._v("\n             ERROR "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1205")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("HY000"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("Lock")]),s._v(" wait timeout exceeded"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" try restarting "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("transaction")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 锁定超时")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("、session1: "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("commit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--提交事务 或者 rollback 释放读锁")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("、session2："),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" mylock "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'y'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--修改成功")]),s._v("\n             Query OK"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("row")]),s._v(" affected "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v(" sec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n             "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("Rows")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("matched")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" Changed: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("Warnings")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("h3",{attrs:{id:"行读锁升级表锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#行读锁升级表锁"}},[s._v("#")]),s._v(" 行读锁升级表锁")]),s._v(" "),a("p",[s._v("当我们加锁的查询条件不是索引时，由于不是索引，因此需要进行全表扫描，所以会逐行加锁，也就是直到事务被提交，行锁由于被逐行遍历，会相当于锁了整张表，变为表锁。")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("、session1: "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("begin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--开启事务未提交")]),s._v("\n             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--手动加name='c'的行读锁,未使用索引")]),s._v("\n             "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" mylock  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'c'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("lock")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("share")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("mode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("、session2："),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" mylock "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'y'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 修改阻塞 未用索引行锁升级为表锁")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("、session1: "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("commit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--提交事务 或者 rollback 释放读锁")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("、session2："),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" mylock "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'y'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--修改成功")]),s._v("\n             Query OK"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("row")]),s._v(" affected "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v(" sec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n             "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("Rows")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("matched")]),s._v(": "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" Changed: "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("Warnings")]),s._v(": \n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("h3",{attrs:{id:"行写锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#行写锁"}},[s._v("#")]),s._v(" 行写锁")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("、session1: "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("begin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--开启事务未提交")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--手动加id=1的行写锁,")]),s._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" mylock  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n     \n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("、session2："),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" mylock  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 可以访问")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("、session2: "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" mylock  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 可以读 不加锁 ")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("、session2: "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" mylock  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("lock")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("in")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("share")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("mode")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 加读锁")]),s._v("\n被阻塞\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("、session1："),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("commit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 提交事务 或者 rollback 释放写锁")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("、session2：执行成功\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("h2",{attrs:{id:"记录锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#记录锁"}},[s._v("#")]),s._v(" 记录锁")]),s._v(" "),a("p",[s._v("以上几种情况通过使用"),a("strong",{staticStyle:{color:"#3EAF7C"}},[s._v("主键等值条件或唯一索引等值条件")]),s._v("产生的锁，都称为记录锁。")]),s._v(" "),a("h2",{attrs:{id:"间隙锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#间隙锁"}},[s._v("#")]),s._v(" 间隙锁")]),s._v(" "),a("p",[s._v("间隙锁是一种"),a("strong",{staticStyle:{color:"#3EAF7C"}},[s._v("用来防止幻读")]),s._v("的锁，例如下面这个图，如果没有间隙锁的保护，让事务 B 插入了数据，则事务 A 两次读到的数据就不一样了。")]),s._v(" "),a("p",[a("img",{attrs:{src:"/mysql_img/huandu.png",alt:"HUANDU"}})]),s._v(" "),a("p",[s._v("不过要注意的是，"),a("strong",{staticStyle:{color:"#3EAF7C"}},[s._v("间隙锁只在隔离级别为可重复读 RR 的情况下产生，因为幻读就是在这个级别下的问题")]),s._v("。")]),s._v(" "),a("h3",{attrs:{id:"什么是间隙锁？"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#什么是间隙锁？"}},[s._v("#")]),s._v(" 什么是间隙锁？")]),s._v(" "),a("p",[s._v("事务加锁后锁住的是表记录的某一个区间，当表的相邻ID之间出现空隙则会形成一个区间，特点是左闭右开，这个被锁住的区间就是间隙锁。间隙锁防止两种情况发生：")]),s._v(" "),a("ul",[a("li",[s._v("1、防止插入间隙内的数据")]),s._v(" "),a("li",[s._v("2、防止已有数据更新为间隙内的数据")])]),s._v(" "),a("h3",{attrs:{id:"间隙锁锁住的范围"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#间隙锁锁住的范围"}},[s._v("#")]),s._v(" 间隙锁锁住的范围")]),s._v(" "),a("p",[s._v("案例demo：")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[s._v("案例演示：\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("create")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" number "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("primary")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("key")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("values")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 加非唯一索引")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("alter")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("table")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("add")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("index")]),s._v(" idx_num"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("number"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("例如存在如下 SQL ：")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" number"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" number"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("当在事务中执行该语句后，根据上面间隙锁的含义，可得锁住的范围是：Id[1,6]、Number[2,5],因此如果要插入或更新数据，有以下几个情况：")]),s._v(" "),a("ul",[a("li",[s._v("id、number均在间隙外，例如 （7，1）")]),s._v(" "),a("li",[s._v("id、number均在间隙内，例如（2，2）")]),s._v(" "),a("li",[s._v("id在间隙内、number在间隙外，例如（2，6）")]),s._v(" "),a("li",[s._v("id在间隙外，number在间隙内，例如（7，3）")]),s._v(" "),a("li",[s._v("id在间隙外，number为上边缘数据，例如（7，2）")]),s._v(" "),a("li",[s._v("id在间隙内，number为上边缘数据，例如（2，2）")]),s._v(" "),a("li",[s._v("id在间隙外，number为下边缘数据，例如（7，5）")]),s._v(" "),a("li",[s._v("id在间隙内，number为下边缘数据，例如（4，5）")])]),s._v(" "),a("h3",{attrs:{id:"案例分析"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#案例分析"}},[s._v("#")]),s._v(" 案例分析")]),s._v(" "),a("p",[a("strong",[s._v("非唯一索引等值更新")])]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 非唯一索引的等值")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("session")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(":\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("start")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("transaction")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" number"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" number"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("session")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(":\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("start")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("transaction")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#（均在间隙内，阻塞）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#（均在间隙外，成功）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#（id在间隙内，number在间隙外，成功）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#（id在间隙内，number在间隙外，成功）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#（id在间隙外，number在间隙内，阻塞）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# (id在间隙外，number为上边缘数据，阻塞)")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#（id在间隙内，number为上边缘数据，阻塞）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#（id在间隙外，number为下边缘数据，成功）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#（id在间隙内，number为下边缘数据，阻塞）")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br")])]),a("p",[s._v("图示：")]),s._v(" "),a("p",[a("img",{attrs:{src:"/mysql_img/gailock.jpg",alt:"img"}})]),s._v(" "),a("p",[s._v("结论：只要 "),a("code",[s._v("number")]),s._v(" 处于区间[2,5)内的数据，即[上边缘，下边缘)，无论 id 是否在间隙内，都会堵塞。如果 "),a("code",[s._v("number")]),s._v(" 是下边缘数据，id 情况是"),a("code",[s._v("外通内堵")]),s._v("。")]),s._v(" "),a("p",[a("strong",[s._v("主键索引范围")])]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--主键索引范围")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("session")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(":\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("start")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("transaction")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" number"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("and")]),s._v(" id "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("session")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(":\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("start")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("transaction")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#（id在间隙内，number在间隙内，阻塞）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#（id在间隙内，number在间隙外，阻塞）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#（id在间隙内，number在间隙外，阻塞）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#（id在间隙外，number在间隙外，成功）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#（id在间隙外，number在间隙内，成功）")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--id无边缘数据，因为主键不能重复")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br")])]),a("p",[s._v("结论：只要主键 "),a("code",[s._v("id")]),s._v(" 处于（2,4,5）范围内，无论 "),a("code",[s._v("number")]),s._v(" 是多少都会堵塞")]),s._v(" "),a("p",[a("strong",[s._v("非唯一索引无穷大/小")])]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--无穷大")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("session")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(":\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("start")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("transaction")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" number"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" number"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 并不存在 number = 13")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("session")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(":\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("start")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("transaction")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#(id在间隙外，number在间隙外，成功)")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#(id在间隙外，number为上边缘数据，成功)")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#(id在间隙内，number为上边缘数据，阻塞)")]),s._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("insert")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("into")]),s._v(" news "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("value")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#(均在间隙内，阻塞)")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br")])]),a("p",[s._v("也就是说，非主键索引无论是等值还是范围查询都会产生间隙锁，主键只有范围查询才会产生间隙锁")]),s._v(" "),a("h2",{attrs:{id:"死锁"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#死锁"}},[s._v("#")]),s._v(" 死锁")]),s._v(" "),a("p",[s._v("死锁是互相等待对方释放资源，又互相占据着对方的资源而产生的，例如：")]),s._v(" "),a("p",[a("img",{attrs:{src:"/mysql_img/deadlock.jpg",alt:"dead"}})]),s._v(" "),a("p",[s._v("事务 A 占据了 "),a("code",[s._v("id=1")]),s._v(" 的写锁，又想申请 "),a("code",[s._v("id=2")]),s._v(" 的锁，事务 B 占据了 "),a("code",[s._v("id=2")]),s._v(" 的写锁，又想申请 "),a("code",[s._v("id=1")]),s._v(" 的锁，因此最终谁也无得得到锁，形成了死锁。")]),s._v(" "),a("div",{staticClass:"language-sql line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("、session1: "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("begin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--开启事务未提交")]),s._v("\n             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--手动加行写锁 id=1 ，使用索引")]),s._v("\n             "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" mylock "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'m'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("、session2："),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("begin")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--开启事务未提交")]),s._v("\n             "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("--手动加行写锁 id=2 ，使用索引")]),s._v("\n             "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" mylock "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'m'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("、session1: "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" mylock "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'nn'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 加写锁被阻塞")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("、session2："),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("update")]),s._v(" mylock "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("set")]),s._v(" name"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("'nn'")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" id"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("-- 加写锁会死锁，不允许操作")]),s._v("\n             ERROR "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1213")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("40001")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(": Deadlock found "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("when")]),s._v(" trying "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("to")]),s._v(" get "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("lock")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" try restarting "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("transaction")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("h3",{attrs:{id:"死锁解决方法"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#死锁解决方法"}},[s._v("#")]),s._v(" 死锁解决方法")]),s._v(" "),a("ul",[a("li",[s._v("一种策略是，直接进入等待，直到超时。这个超时时间可以通过参数 "),a("code",[s._v("innodb_lock_wait_timeout")]),s._v(" 来设置，默认是 50s。")]),s._v(" "),a("li",[s._v("另一种策略是，发起死锁检测，发现死锁后，主动回滚死锁链条中的某一个事务，让其他事务得以继续执行。将参数 "),a("code",[s._v("innodb_deadlock_detect")]),s._v(" 设置为 on，表示开启这个逻辑。")])])])}),[],!1,null,null,null);t.default=n.exports}}]);