<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MySQL 架构 | HuangXinJian</title>
    <meta name="description" content="If you learn, learn deeply please!">
    <meta name="generator" content="VuePress 1.3.1">
    <link rel="icon" href="/H.png">
    
    <link rel="preload" href="/assets/css/0.styles.77838d5e.css" as="style"><link rel="preload" href="/assets/js/app.78cba7d9.js" as="script"><link rel="preload" href="/assets/js/2.b97de27f.js" as="script"><link rel="preload" href="/assets/js/9.68f4fa83.js" as="script"><link rel="prefetch" href="/assets/js/10.5a39f9cf.js"><link rel="prefetch" href="/assets/js/11.fc6bddf2.js"><link rel="prefetch" href="/assets/js/12.da1eaab3.js"><link rel="prefetch" href="/assets/js/13.3e791f4e.js"><link rel="prefetch" href="/assets/js/14.5953a388.js"><link rel="prefetch" href="/assets/js/15.b9e792e3.js"><link rel="prefetch" href="/assets/js/16.14be3228.js"><link rel="prefetch" href="/assets/js/17.d8c48abe.js"><link rel="prefetch" href="/assets/js/18.c1171d86.js"><link rel="prefetch" href="/assets/js/19.687638f3.js"><link rel="prefetch" href="/assets/js/20.dbb7c712.js"><link rel="prefetch" href="/assets/js/21.fcac9d7b.js"><link rel="prefetch" href="/assets/js/22.05c89a82.js"><link rel="prefetch" href="/assets/js/23.6f455ef9.js"><link rel="prefetch" href="/assets/js/24.a5f5dd42.js"><link rel="prefetch" href="/assets/js/25.ddacf5f1.js"><link rel="prefetch" href="/assets/js/26.1dbabccd.js"><link rel="prefetch" href="/assets/js/27.4d3ddddd.js"><link rel="prefetch" href="/assets/js/28.aca93b2e.js"><link rel="prefetch" href="/assets/js/29.4e592fcf.js"><link rel="prefetch" href="/assets/js/3.8c3b122e.js"><link rel="prefetch" href="/assets/js/30.07e05cf0.js"><link rel="prefetch" href="/assets/js/31.4bc393d7.js"><link rel="prefetch" href="/assets/js/32.5bed9ede.js"><link rel="prefetch" href="/assets/js/33.b1d61159.js"><link rel="prefetch" href="/assets/js/34.27c7f1f1.js"><link rel="prefetch" href="/assets/js/35.17c92a26.js"><link rel="prefetch" href="/assets/js/36.91a5ecf5.js"><link rel="prefetch" href="/assets/js/37.88c250af.js"><link rel="prefetch" href="/assets/js/38.6d72295b.js"><link rel="prefetch" href="/assets/js/39.0e585af1.js"><link rel="prefetch" href="/assets/js/4.ff5f2a88.js"><link rel="prefetch" href="/assets/js/40.80a7f1c2.js"><link rel="prefetch" href="/assets/js/41.defa3efa.js"><link rel="prefetch" href="/assets/js/42.70857ada.js"><link rel="prefetch" href="/assets/js/5.68065b24.js"><link rel="prefetch" href="/assets/js/6.bb2aa06c.js"><link rel="prefetch" href="/assets/js/7.f469350c.js"><link rel="prefetch" href="/assets/js/8.37ca51cf.js">
    <link rel="stylesheet" href="/assets/css/0.styles.77838d5e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">HuangXinJian</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="NodeJS" class="dropdown-title"><span class="title">NodeJS</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nodejs/NodeJS基础/NodeJS介绍.html" class="nav-link">
  NodeJS 基础
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/baseJava/Java 介绍.html" class="nav-link">
  Java 基础
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分布式" class="dropdown-title"><span class="title">分布式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/distributed/frameworkHistory/架构演变历史.html" class="nav-link">
  分布式学习路线
</a></li><li class="dropdown-item"><!----> <a href="/distributed/registerCenter/" class="nav-link">
  注册中心
</a></li><li class="dropdown-item"><!----> <a href="/distributed/messageSystem/" class="nav-link">
  消息系统
</a></li><li class="dropdown-item"><!----> <a href="/distributed/internal/" class="nav-link">
  网络框架
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          关系型数据库
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/database/RDB/MySQL_Learn/MySQL安装.html" class="nav-link">
  MySQL
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://github.com/huangxinjian/huangxinjian.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="NodeJS" class="dropdown-title"><span class="title">NodeJS</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nodejs/NodeJS基础/NodeJS介绍.html" class="nav-link">
  NodeJS 基础
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/baseJava/Java 介绍.html" class="nav-link">
  Java 基础
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分布式" class="dropdown-title"><span class="title">分布式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/distributed/frameworkHistory/架构演变历史.html" class="nav-link">
  分布式学习路线
</a></li><li class="dropdown-item"><!----> <a href="/distributed/registerCenter/" class="nav-link">
  注册中心
</a></li><li class="dropdown-item"><!----> <a href="/distributed/messageSystem/" class="nav-link">
  消息系统
</a></li><li class="dropdown-item"><!----> <a href="/distributed/internal/" class="nav-link">
  网络框架
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          关系型数据库
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/database/RDB/MySQL_Learn/MySQL安装.html" class="nav-link">
  MySQL
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://github.com/huangxinjian/huangxinjian.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>MySQL</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/database/RDB/MySQL_Learn/MySQL安装.html" class="sidebar-link">MySQL 单机安装</a></li><li><a href="/database/RDB/MySQL_Learn/MySQL基础语法.html" class="sidebar-link">MySQL 基础语法</a></li><li><a href="/database/RDB/MySQL_Learn/MySQL架构.html" class="active sidebar-link">MySQL 架构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL架构.html#逻辑架构" class="sidebar-link">逻辑架构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL架构.html#逻辑架构图" class="sidebar-link">逻辑架构图</a></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL架构.html#sql-执行顺序" class="sidebar-link">SQL 执行顺序</a></li></ul></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL架构.html#存储引擎" class="sidebar-link">存储引擎 💥</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL架构.html#memory" class="sidebar-link">Memory</a></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL架构.html#myisam" class="sidebar-link">MyISAM</a></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL架构.html#innodb" class="sidebar-link">InnoDB</a></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL架构.html#innodb-和-myisam-的区别" class="sidebar-link">InnoDB 和 MyISAM 的区别 ❓</a></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL架构.html#技术选型" class="sidebar-link">技术选型</a></li></ul></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL架构.html#物理架构" class="sidebar-link">物理架构</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL架构.html#日志文件种类" class="sidebar-link">日志文件种类</a></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL架构.html#错误日志" class="sidebar-link">错误日志</a></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL架构.html#通用查询日志" class="sidebar-link">通用查询日志</a></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL架构.html#慢查询日志" class="sidebar-link">慢查询日志</a></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL架构.html#二进制文件" class="sidebar-link">二进制文件 👍</a></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL架构.html#重做日志" class="sidebar-link">重做日志 👍</a></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL架构.html#回滚日志" class="sidebar-link">回滚日志 👍</a></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL架构.html#中继日志" class="sidebar-link">中继日志 👍</a></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL架构.html#数据文件" class="sidebar-link">数据文件</a></li></ul></li></ul></li><li><a href="/database/RDB/MySQL_Learn/MySQL索引.html" class="sidebar-link">MySQL 索引</a></li><li><a href="/database/RDB/MySQL_Learn/MySQL索引详细分析.html" class="sidebar-link">MySQL 索引详细分析</a></li><li><a href="/database/RDB/MySQL_Learn/MySQL锁.html" class="sidebar-link">MySQL 锁</a></li><li><a href="/database/RDB/MySQL_Learn/MySQL事务.html" class="sidebar-link">MySQL 事务</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mysql-架构"><a href="#mysql-架构" class="header-anchor">#</a> MySQL 架构</h1> <p>想要熟悉 MySQL，首先就得清楚 MySQL 中的设计架构，分别有哪些模块，模块对应的功能又是什么。下面将详细介绍 MySQL 的架构。</p> <h2 id="逻辑架构"><a href="#逻辑架构" class="header-anchor">#</a> 逻辑架构</h2> <p>首先看一下 MySQL 的架构图：</p> <p><img src="/mysql_img/mysql-jiagou.jpg" alt="mysqljiagoutu"></p> <p>需要重点关注的是：</p> <ul><li><code>Connection Pool</code> 连接池</li> <li><code>SQL Interface</code> SQL接口层</li> <li><code>Parser</code> 解析器</li> <li><code>Optimizer</code> 优化器</li> <li><code>Cache &amp; Buffers</code> 缓存</li> <li><code>Pluggable Storage Engines</code> 插拔式存储引擎</li></ul> <h3 id="逻辑架构图"><a href="#逻辑架构图" class="header-anchor">#</a> 逻辑架构图</h3> <p><img src="/mysql_img/sqlshunxu.jpg" alt="image"></p> <h3 id="sql-执行顺序"><a href="#sql-执行顺序" class="header-anchor">#</a> SQL 执行顺序</h3> <h4 id="连接池"><a href="#连接池" class="header-anchor">#</a> 连接池</h4> <p>连接池负责管理用户的连接，当用户通过网络往 <code>MySQL</code> 发起连接请求时，就会通过这个模块进行管理，也就是以下命令：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>mysql <span class="token operator">-</span>h$ip <span class="token operator">-</span>P$port <span class="token operator">-</span>u$<span class="token keyword">user</span> <span class="token operator">-</span>p
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>当完成 TCP 连接后，就会检查用户输入的用户名和密码是否正确：</p> <ul><li>如果密码错误，就会报出错误 <code>Access denied for user</code></li> <li>如果验证通过，<strong style="color:#3EAF7C;">就会去权限表中加载当前用户拥有的权限，并且之后这条连接的权限判断的逻辑，都依赖此时读到的逻辑</strong></li></ul> <blockquote><p>因为如果管理员在用户 A 登录后，再修改用户 A 的权限是不会起作用的。修改后的权限只对新连接起作用</p></blockquote> <p>连接成功后，如果没有后续操作，该条连接就会进入<strong style="color:#3EAF7C;">空闲状态</strong>，直到 Mysql 将其断开。这个持续时间默认是 8 小时，可以通过参数 <code>wait_timeout</code> 控制。</p> <p>如果想查询空闲连接，可以通过 <code>show processlist</code> 查看当前所有连接的状态：</p> <p><img src="https://static001.geekbang.org/resource/image/f2/ed/f2da4aa3a672d48ec05df97b9f992fed.png" alt="image"></p> <p>如果超时断开后，客户端发起请求，则会收到一个错误提示 ： <code>Lost connection to MySQL server during query</code> ，这时候我们需要重新连接后才能发起请求。</p> <h5 id="长连接与短连接"><a href="#长连接与短连接" class="header-anchor">#</a> 长连接与短连接</h5> <p>数据库里连接一共分为长连接和短连接，其中：</p> <ul><li>长连接是指连接成功后，客户端不断有请求发送，此时会一直使用同一个连接。</li> <li>而短连接是每次执行完很少的几次查询就会断开连接，下次查询重新建立一个。</li></ul> <p>建立连接的过程是比较复杂的，因此<strong style="color:#3EAF7C;">建议通常使用长连接</strong>， 即连接池。</p> <p>但是如果大量使用长连接，则会出现内存暴涨的情况，这是因为 <strong>MySQL</strong> 在执行过程中临时使用的内存是管理在连接对象里面的，只要这些资源没被释放，内存也不会被释放。</p> <p>因此为了解决该方案，我们需要：</p> <ul><li>定期断开长连接</li> <li>如果是 5.7 或更新版本，可以通过 <strong>mysql_reset_connection</strong> 来重新初始化连接资源，这个过程不需要重连和权限验证，只会将连接恢复到刚刚创建时的状态。</li></ul> <h4 id="sql-接口层"><a href="#sql-接口层" class="header-anchor">#</a> SQL 接口层</h4> <p>连接成功后，发起查询请求：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">user</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>这时就会被 SQL 接口层接受该条 SQL, <strong style="color:#3EAF7C;">然后判断该用户是否有操作这个表的权限</strong>，如果有就传递解析器进行处理。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>其实在传递给解析器之前，会先去 Cache 缓存中查询，不过 8.0 后就已经移除缓存了，这个缓存的作用并不大。</p></div> <h4 id="查询缓存"><a href="#查询缓存" class="header-anchor">#</a> 查询缓存</h4> <blockquote><p>mysql 8.0 后移除了这个模块</p></blockquote> <p>MySQL拿到一个查询请求后，会先到查询缓存中查看该条语句是否被执行过，之前执行过的语句和查询出来的结果会以 <code>key-value</code> 的形式缓存在内存中，其中 <code>key</code> 是查询的语句，<code>value</code> 是查询的结果。</p> <p>如果我们的查询语句可以直接在缓存中找到对应的 <code>key</code>，则可以直接返回结果，不用继续走下面复杂的流程。因此这样的效率是很高的！</p> <p>但是，大多数情况下不建议使用查询缓存，它会弊大于利，因为<strong style="color:#3EAF7C;">只要有一条记录对这个表进行更新，这个表上的所有查询缓存都会失效，</strong>因此查询缓存只能有效用于静态表，例如 系统配置表。</p> <p>因此，MySQL 也提供了一种方式让我们按需索取该功能，即我们可以将参数 <code>query_cache_type</code> 设置成 <code>DEMAND</code>, 这样对于默认的查询SQL都不会使用查询缓存。</p> <p>当我们需要使用到查询缓存的时候，可以通过显示指定 <code>SQL_CACHE</code> :</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> SQL_CACHE <span class="token operator">*</span> <span class="token keyword">from</span> T <span class="token keyword">where</span> ID<span class="token operator">=</span><span class="token number">10</span>；
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="解析器"><a href="#解析器" class="header-anchor">#</a> 解析器</h4> <p>解析器拿到 SQL 语句后，会进行两步解析：</p> <ul><li>词法解析</li> <li>语法解析</li></ul> <p>其中词法解析就是解剖 SQL 语句，将其中的每个单词都分离出来，挂载到一颗语法树上，大概是这种效果：</p> <p><img src="/mysql_img/mysql_cifajiexi.jpg" alt="IMAGE"></p> <p>词法解析完成后就会进行语法解析，MySQL 会判断你的 SQL 语句存不存在语法错误。如果存在错误，一般会报出这样的异常：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>You have an error <span class="token operator">in</span> your <span class="token keyword">SQL</span> syntax<span class="token punctuation">;</span> <span class="token keyword">check</span> the manual that corresponds <span class="token keyword">to</span> your MySQL server version <span class="token keyword">for</span> the <span class="token keyword">right</span> syntax <span class="token keyword">to</span> <span class="token keyword">use</span> near <span class="token string">'elect * from t where ID=1'</span> at line <span class="token number">1</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>一般语法会提示第一个出现错误的位置，因此我们需要关注紧接 use near 后面的内容</p></div> <h4 id="优化器"><a href="#优化器" class="header-anchor">#</a> 优化器</h4> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>性能优化就是指的这一块了</p></div> <p>经过了分析器后，MySQL 已经知道我们要做什么了，然后在执行前，还要先经过 优化器 为我们的 SQL 进行优化。</p> <p>优化器是在一个表有多个索引的时候，决定使用哪个索引；或者在一个语句有多表关联的时候，决定各个表的连接顺序，例如：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> t1 <span class="token keyword">join</span> t2 <span class="token keyword">using</span><span class="token punctuation">(</span>ID<span class="token punctuation">)</span>  <span class="token keyword">where</span> t1<span class="token punctuation">.</span>c<span class="token operator">=</span><span class="token number">10</span> <span class="token operator">and</span> t2<span class="token punctuation">.</span>d<span class="token operator">=</span><span class="token number">20</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ol><li>既可以先从表 t1 中取出 c=10的数据，然后再跟 t2 连接，再判断 t2.d=20 的数据。</li> <li>也可以先从表 t2 里面取出 d=20 的记录的 ID 值，再根据 ID 值关联到 t1，再判断 t1 里面 c 的值是否等于 10。</li></ol> <p>这两种方案最终得到的结果都是一样的，但是效率可能识不同的，因此这就是优化器的工作。</p> <blockquote><p>优化器不一定是每次都能做到 提高效率的优化！</p></blockquote> <h4 id="执行器"><a href="#执行器" class="header-anchor">#</a> 执行器</h4> <p>MySQL 通过分析器分析你要做什么，通过优化器知道要怎么做，然后就来到最后一步 执行器 阶段了。</p> <p>在执行语句前，会先判断你对这个表有没有操作权限，如果没有，则会返回没有权限的错误信息。例如：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>mysql<span class="token operator">&gt;</span> <span class="token keyword">select</span> * from T where <span class="token assign-left variable">ID</span><span class="token operator">=</span><span class="token number">10</span><span class="token punctuation">;</span>
ERROR <span class="token number">1142</span> <span class="token punctuation">(</span><span class="token number">42000</span><span class="token punctuation">)</span>: SELECT <span class="token builtin class-name">command</span> denied to user <span class="token string">'b'</span>@<span class="token string">'localhost'</span> <span class="token keyword">for</span> table <span class="token string">'T'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="custom-block danger"><p class="custom-block-title">注意</p> <p>如果语句命中了查询缓存，也会在返回结果之前查看是否有权限。同时，在优化器之前也会调用 precheck 做权限验证。</p></div> <p>如果存在权限，则会打开表继续执行，打开表的时候，执行器就会根据这个表的存储引擎定义，去使用这个引擎提供的接口。</p> <p>比如上面的这一条SQL,执行器的执行流程就是这样的（ID并不是主键，不存在索引）：</p> <ol><li>调用 InnoDB 引擎接口取这个表的第一行，判断 ID 是否等于 10，如果不是则跳过，如果是则将 该记录存储到结果集中。</li> <li>调用引擎取下一行，以此类推。直到取到这个表的最后一行</li> <li>然后将最终的<strong>行记录集</strong>返回给客户端</li></ol> <p>我们可以在 慢查询日志 中看到一个 <code>row_examined</code> 的字段，表示了这条 <code>SQL</code> 扫描了多少行，这个值就是执行器调用存储引擎获取数据行的时候累加的。</p> <blockquote><p>在有些场景下，执行器调用一次，在引擎内部则扫描了多行，因此引擎扫描行数跟 <code>rows_examined</code> 并不是完全相同的。</p></blockquote> <p>至此，一条SQL已经执行完毕了。</p> <h2 id="存储引擎"><a href="#存储引擎" class="header-anchor">#</a> 存储引擎 💥</h2> <p>在创建表的时候，通常可以<strong>为表指定</strong>一个存储引擎，它规定了表中数据、索引的存储结构：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">create</span> <span class="token keyword">table</span> xxx<span class="token punctuation">(</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">)</span> <span class="token keyword">engine</span><span class="token operator">=</span><span class="token keyword">InnoDB</span><span class="token operator">/</span>Memory<span class="token operator">/</span>MyISAM
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>表一旦被创建，存储结构就无法被改变。</p></div> <p>上面指定的 <code>InnoDB</code> 、<code>MyISAM</code>、<code>Memory</code> 就是 MySQL 中最常用的三种存储引擎了。</p> <h3 id="memory"><a href="#memory" class="header-anchor">#</a> Memory</h3> <p><code>Memory</code> 是内存存储引擎，特点是<strong style="color:#3EAF7C;">存储、查询速度极快，但是不能持久化数据，适合存储系统的一些配置信息，每次启动时都会加载</strong>。对于核心数据不建议使用该存储引擎，因为会导致数据丢失。</p> <h3 id="myisam"><a href="#myisam" class="header-anchor">#</a> MyISAM</h3> <p><code>MyISAM</code> 是 MySQL 原生支持的存储引擎，它拥有<strong style="color:#3EAF7C;">较高的存储效率</strong>。但是它不支持事务、不支持行锁。</p> <h3 id="innodb"><a href="#innodb" class="header-anchor">#</a> InnoDB</h3> <p><code>InnoDB</code> 是由第三方公司开发的，它的插入、查询速度比 <code>MyISAM</code> 要稍微慢些，但是它<strong style="color:#3EAF7C;">支持事务、行级锁、回滚、崩溃恢复以及多版本并发控制</strong>。</p> <h3 id="innodb-和-myisam-的区别"><a href="#innodb-和-myisam-的区别" class="header-anchor">#</a> InnoDB 和 MyISAM 的区别 ❓</h3> <p><img src="/mysql_img/innodbandmyisam.jpg" alt="ima"></p> <h3 id="技术选型"><a href="#技术选型" class="header-anchor">#</a> 技术选型</h3> <ol><li>如果对数据的插入、查询性能要求很高，但是不需要数据的持久化，并且表的大小不是很大，则可以使用 <code>Memory</code> 存储引擎</li> <li>如果要求较高的插入、查询效率，对并发要求不高，则可以使用 <code>MyISAM</code> 存储引擎</li> <li>如果需要对事务的完整性要求比较高（比如银行），要求实现并发控制（比如售票），那选择 <code>InnoDB</code> 有很大的优势。如果需要频繁的更新、删除操作的数据库，也可以选择 <code>InnoDB</code>，因为支持事务的提交<code>（commit）</code>和回滚<code>（rollback）</code>。</li></ol> <h2 id="物理架构"><a href="#物理架构" class="header-anchor">#</a> 物理架构</h2> <p>MySQL 实际上是通过文件来管理数据索引以及日志的，在 MySQL 中，一共分为两种文件：</p> <ul><li>日志文件</li> <li>数据索引文件</li></ul> <p>其中日志文件采用<strong style="color:#3EAF7C;">顺序IO</strong>的方式写入，速度快，空间利用率低，数据索引文件采用<strong style="color:#3EAF7C;">随机IO</strong>的方式写入，需要记录地址，比较慢，但是空间利用率高</p> <p>另外，MySQL在 <code>Linux</code> 中的数据索引文件和日志文件都在 <code>/var/lib/mysql</code> 目录下。</p> <p><img src="/mysql_img/FILE.jpg" alt="img"></p> <h3 id="日志文件种类"><a href="#日志文件种类" class="header-anchor">#</a> 日志文件种类</h3> <p>MySQL 中，日志文件有很多种，分别是：</p> <ul><li>错误日志 <code>error log</code></li> <li>通用查询日志 <code>general query log</code></li> <li>慢查询日志 <code>slow query log</code></li> <li>二进制日志 <code>binlog</code></li> <li>重做日志 <code>redo log</code></li> <li>回滚日志 <code>undo log</code></li> <li>中继日志 <code>relay log</code></li></ul> <p>如果想要查看日志的开启情况，可以通过命令：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'log_%'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="错误日志"><a href="#错误日志" class="header-anchor">#</a> 错误日志</h3> <p><strong style="color:#3EAF7C;">默认是开启的，而且从5.5.7以后无法关闭错误日志</strong>，错误日志记录了运行过程中遇到的所有严重的错误信息,以及 MySQL每次启动和关闭的详细信息</p> <h3 id="通用查询日志"><a href="#通用查询日志" class="header-anchor">#</a> 通用查询日志</h3> <p>这个一般在生产中是不会开启的，因为它会记录所有的 SQL 操作，十分影响性能。</p> <h3 id="慢查询日志"><a href="#慢查询日志" class="header-anchor">#</a> 慢查询日志</h3> <p>SQL 调优时使用，可以查看一些 SQL 执行慢的语句，默认是关闭的。需要通过以下设置进行开启：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#开启慢查询日志</span>
<span class="token assign-left variable">slow_query_log</span><span class="token operator">=</span>ON
<span class="token comment">#慢查询的阈值</span>
<span class="token assign-left variable">long_query_time</span><span class="token operator">=</span><span class="token number">3</span>
<span class="token comment">#日志记录文件如果没有给出file_name值， 默认为主机名，后缀为-slow.log。</span>
<span class="token comment">#如果给出了文件名，但不是绝对路径名，文件则写入数据目录。</span>
<span class="token assign-left variable">slow_query_log_file</span><span class="token operator">=</span>file_name
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="二进制文件"><a href="#二进制文件" class="header-anchor">#</a> 二进制文件 👍</h3> <p><code>bin log</code> 是 MySQL 中最重要的日志文件之一，它<strong style="color:#3EAF7C;">记录了数据库所有的ddl语句和dml语句，但不包括select语句内容</strong>。</p> <p>语句以事件的形式保存，描述了数据的变更顺序，binlog还包括了每个更新语句的执行时间信息。如果是DDL语句，则直接记录到 <code>binlog</code> 日志，而 <code>DML语句</code>，必须通过事务提交才能记录到 <code>binlog</code>日志中，生产中开启。</p> <p>后面要介绍的主从复制、主备、数据恢复都是依赖 <code>binlog</code> 来操作的。</p> <h3 id="重做日志"><a href="#重做日志" class="header-anchor">#</a> 重做日志 👍</h3> <p><code>redo log</code> 是属于存储引擎 <code>InnoDB</code> 特有的日志，每当有一个 <code>DML操作</code> ，就会记录多一条回滚操作到 <code>redo log</code> 中，同时 <code>redo log</code> 还会记录数据的变化情况。</p> <p>该日志文件是存储在 <code>var/lib/mysql</code> 下的 <code>ib_logfile0</code> 和 <code>ib_logfile1</code> ，这两个文件就是重做日志，大小每个 8M。可以通过 <code>show variables like 'innodb_log%'</code> 查询</p> <p>作用：</p> <ul><li>防止在发生故障的时间点时，内存中尚有脏页</li> <li>如果未写入磁盘（事务提交之后，数据写入磁盘之前宕机），在重启mysql服务的时候，根据redo log进行重做，从而达到事务的持久性这一特性。</li></ul> <p>内容：</p> <ul><li>物理格式的日志，记录的是物理数据页面的修改信息，其 <code>redo log</code> 是顺序IO写入 <code>redo log file</code> 的物理文件中去的。</li></ul> <p>生成时机：</p> <ul><li><strong style="color:#3EAF7C;">事务开始之后就产生redo log，redo log的落盘并不是随着事务的提交才写入的</strong>，而是在事务的执行过程中，便开始写入redo log文件中。</li></ul> <p>释放时机：</p> <ul><li>当对应事务的脏页写入到磁盘之后，redo log的使命也就完成了，重做日志占用的空间就可以重用（被覆盖）。</li></ul> <h3 id="回滚日志"><a href="#回滚日志" class="header-anchor">#</a> 回滚日志 👍</h3> <p><code>回滚日志</code> 称为 <code>undo log</code>，这个记录也是记录在 <code>redo log</code> 里面的。可以将 <code>undo log</code> 理解为跟数据页一样类型的数据，只不过数据页记录的是新数据，<code>undo log page</code> 记录的是回滚数据</p> <p>作用：</p> <ul><li>保存了事务发生之前数据的一个版本，可以用于回滚。事务回滚时，会根据 <code>undo log</code> 将数据从逻辑上恢复至事务之前的状态。</li></ul> <p>内容：</p> <ul><li>逻辑格式的日志，在执行 <code>undo</code> 的时候，仅仅是将数据从逻辑上恢复至事务之前的状态，而不是从物理页面上操作实现的，这一点是不同于 <code>redo log</code> 的。</li></ul> <p>生成时机：</p> <ul><li>事务开始之前，将当前事务版本生成 undo log，<strong style="color:#3EAF7C;">undo 也会产生 redo 来保证 undo log 的可靠性。</strong></li> <li>每一次写操作都会生成 undo log
<ul><li>比如 update 操作，会生成一条更新前的记录信息，比如主键ID，需要更新的字段以及字段对应的旧值。</li> <li>对于 DELETE 操作，在 delete mark 操作时，会获取该条记录最近一次的 undo log 记录</li></ul></li> <li>生成的新的 undo log 记录了旧记录的 <code>trx_id</code>（事务编号） 和 <code>old roll_pointer</code>（上一个 undo log 的位置,回滚指针） ，这样回滚时，就可以直接找到删除之前的 undo log 进行回滚操作。</li></ul> <p>释放时机：</p> <ul><li>当事务提交之后，undo log并不能立马被删除，而是放入待清理的链表，由 purge 线程判断是否有其他事务在使用 undo 段中表的上一个事务之前的版本信息，决定是否可以清理 undo log 的日志空间</li></ul> <h3 id="中继日志"><a href="#中继日志" class="header-anchor">#</a> 中继日志 👍</h3> <h3 id="数据文件"><a href="#数据文件" class="header-anchor">#</a> 数据文件</h3> <p>如果使用 <code>InnoDB</code> 引擎，则数据文件分为三种：</p> <ul><li><code>.frm</code>：表结构定义文件</li> <li><code>.ibd</code>: 使用<strong style="color:#3EAF7C;">独享表空间</strong>保存表数据和索引信息，一个表对应一个 <code>.ibd</code> 文件。</li> <li><code>ibdata</code>：使用<strong style="color:#3EAF7C;">共享表空间</strong>保存表数据和索引信息，所有表共同使用一个或多个 <code>.ibdata</code> 文件。</li></ul> <p>如果使用 <code>MyISAM</code> 引擎，数据文件也分为三种，不过数据和索引是分开存放的：</p> <ul><li><code>.frm</code>：表结构定义文件</li> <li><code>.myd</code>: 主要用来存储表数据信息</li> <li><code>.myi</code>: 主要用来存储表数据文件中任何索引的索引树</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">2020-3-17 9:00:53 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/database/RDB/MySQL_Learn/MySQL基础语法.html" class="prev">
        MySQL 基础语法
      </a></span> <span class="next"><a href="/database/RDB/MySQL_Learn/MySQL索引.html">
        MySQL 索引
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.78cba7d9.js" defer></script><script src="/assets/js/2.b97de27f.js" defer></script><script src="/assets/js/9.68f4fa83.js" defer></script>
  </body>
</html>
