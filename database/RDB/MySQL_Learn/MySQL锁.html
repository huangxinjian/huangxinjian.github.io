<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MySQL 锁 | HuangXinJian</title>
    <meta name="description" content="If you learn, learn deeply please!">
    <meta name="generator" content="VuePress 1.3.1">
    <link rel="icon" href="/H.png">
    
    <link rel="preload" href="/assets/css/0.styles.77838d5e.css" as="style"><link rel="preload" href="/assets/js/app.78cba7d9.js" as="script"><link rel="preload" href="/assets/js/2.b97de27f.js" as="script"><link rel="preload" href="/assets/js/12.da1eaab3.js" as="script"><link rel="prefetch" href="/assets/js/10.5a39f9cf.js"><link rel="prefetch" href="/assets/js/11.fc6bddf2.js"><link rel="prefetch" href="/assets/js/13.3e791f4e.js"><link rel="prefetch" href="/assets/js/14.5953a388.js"><link rel="prefetch" href="/assets/js/15.b9e792e3.js"><link rel="prefetch" href="/assets/js/16.14be3228.js"><link rel="prefetch" href="/assets/js/17.d8c48abe.js"><link rel="prefetch" href="/assets/js/18.c1171d86.js"><link rel="prefetch" href="/assets/js/19.687638f3.js"><link rel="prefetch" href="/assets/js/20.dbb7c712.js"><link rel="prefetch" href="/assets/js/21.fcac9d7b.js"><link rel="prefetch" href="/assets/js/22.05c89a82.js"><link rel="prefetch" href="/assets/js/23.6f455ef9.js"><link rel="prefetch" href="/assets/js/24.a5f5dd42.js"><link rel="prefetch" href="/assets/js/25.ddacf5f1.js"><link rel="prefetch" href="/assets/js/26.1dbabccd.js"><link rel="prefetch" href="/assets/js/27.4d3ddddd.js"><link rel="prefetch" href="/assets/js/28.aca93b2e.js"><link rel="prefetch" href="/assets/js/29.4e592fcf.js"><link rel="prefetch" href="/assets/js/3.8c3b122e.js"><link rel="prefetch" href="/assets/js/30.07e05cf0.js"><link rel="prefetch" href="/assets/js/31.4bc393d7.js"><link rel="prefetch" href="/assets/js/32.5bed9ede.js"><link rel="prefetch" href="/assets/js/33.b1d61159.js"><link rel="prefetch" href="/assets/js/34.27c7f1f1.js"><link rel="prefetch" href="/assets/js/35.17c92a26.js"><link rel="prefetch" href="/assets/js/36.91a5ecf5.js"><link rel="prefetch" href="/assets/js/37.88c250af.js"><link rel="prefetch" href="/assets/js/38.6d72295b.js"><link rel="prefetch" href="/assets/js/39.0e585af1.js"><link rel="prefetch" href="/assets/js/4.ff5f2a88.js"><link rel="prefetch" href="/assets/js/40.80a7f1c2.js"><link rel="prefetch" href="/assets/js/41.defa3efa.js"><link rel="prefetch" href="/assets/js/42.70857ada.js"><link rel="prefetch" href="/assets/js/5.68065b24.js"><link rel="prefetch" href="/assets/js/6.bb2aa06c.js"><link rel="prefetch" href="/assets/js/7.f469350c.js"><link rel="prefetch" href="/assets/js/8.37ca51cf.js"><link rel="prefetch" href="/assets/js/9.68f4fa83.js">
    <link rel="stylesheet" href="/assets/css/0.styles.77838d5e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">HuangXinJian</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="NodeJS" class="dropdown-title"><span class="title">NodeJS</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nodejs/NodeJS基础/NodeJS介绍.html" class="nav-link">
  NodeJS 基础
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/baseJava/Java 介绍.html" class="nav-link">
  Java 基础
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分布式" class="dropdown-title"><span class="title">分布式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/distributed/frameworkHistory/架构演变历史.html" class="nav-link">
  分布式学习路线
</a></li><li class="dropdown-item"><!----> <a href="/distributed/registerCenter/" class="nav-link">
  注册中心
</a></li><li class="dropdown-item"><!----> <a href="/distributed/messageSystem/" class="nav-link">
  消息系统
</a></li><li class="dropdown-item"><!----> <a href="/distributed/internal/" class="nav-link">
  网络框架
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          关系型数据库
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/database/RDB/MySQL_Learn/MySQL安装.html" class="nav-link">
  MySQL
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://github.com/huangxinjian/huangxinjian.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="NodeJS" class="dropdown-title"><span class="title">NodeJS</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/nodejs/NodeJS基础/NodeJS介绍.html" class="nav-link">
  NodeJS 基础
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/java/baseJava/Java 介绍.html" class="nav-link">
  Java 基础
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="分布式" class="dropdown-title"><span class="title">分布式</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/distributed/frameworkHistory/架构演变历史.html" class="nav-link">
  分布式学习路线
</a></li><li class="dropdown-item"><!----> <a href="/distributed/registerCenter/" class="nav-link">
  注册中心
</a></li><li class="dropdown-item"><!----> <a href="/distributed/messageSystem/" class="nav-link">
  消息系统
</a></li><li class="dropdown-item"><!----> <a href="/distributed/internal/" class="nav-link">
  网络框架
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="数据库" class="dropdown-title"><span class="title">数据库</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>
          关系型数据库
        </h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/database/RDB/MySQL_Learn/MySQL安装.html" class="nav-link">
  MySQL
</a></li></ul></li></ul></div></div><div class="nav-item"><a href="https://github.com/huangxinjian/huangxinjian.github.io" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>MySQL</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/database/RDB/MySQL_Learn/MySQL安装.html" class="sidebar-link">MySQL 单机安装</a></li><li><a href="/database/RDB/MySQL_Learn/MySQL基础语法.html" class="sidebar-link">MySQL 基础语法</a></li><li><a href="/database/RDB/MySQL_Learn/MySQL架构.html" class="sidebar-link">MySQL 架构</a></li><li><a href="/database/RDB/MySQL_Learn/MySQL索引.html" class="sidebar-link">MySQL 索引</a></li><li><a href="/database/RDB/MySQL_Learn/MySQL索引详细分析.html" class="sidebar-link">MySQL 索引详细分析</a></li><li><a href="/database/RDB/MySQL_Learn/MySQL锁.html" class="active sidebar-link">MySQL 锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL锁.html#mysql-锁种类" class="sidebar-link">MySQL 锁种类</a></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL锁.html#表级锁种类" class="sidebar-link">表级锁种类</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL锁.html#查看锁表情况" class="sidebar-link">查看锁表情况</a></li></ul></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL锁.html#表级锁之表锁" class="sidebar-link">表级锁之表锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL锁.html#表锁的表现形式" class="sidebar-link">表锁的表现形式</a></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL锁.html#表锁的添加删除和查看" class="sidebar-link">表锁的添加删除和查看</a></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL锁.html#表锁演示" class="sidebar-link">表锁演示</a></li></ul></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL锁.html#表级锁之mdl锁" class="sidebar-link">表级锁之MDL锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL锁.html#mdl锁演示" class="sidebar-link">MDL锁演示</a></li></ul></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL锁.html#表级锁之意向锁" class="sidebar-link">表级锁之意向锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL锁.html#意向锁解决的问题" class="sidebar-link">意向锁解决的问题</a></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL锁.html#意向锁兼容图" class="sidebar-link">意向锁兼容图</a></li></ul></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL锁.html#行级锁" class="sidebar-link">行级锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL锁.html#共享读和排他写" class="sidebar-link">共享读和排他写</a></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL锁.html#添加行锁" class="sidebar-link">添加行锁</a></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL锁.html#查看行锁状态" class="sidebar-link">查看行锁状态</a></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL锁.html#两阶段锁提交" class="sidebar-link">两阶段锁提交</a></li></ul></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL锁.html#行级锁演示" class="sidebar-link">行级锁演示</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL锁.html#行读锁" class="sidebar-link">行读锁</a></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL锁.html#行读锁升级表锁" class="sidebar-link">行读锁升级表锁</a></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL锁.html#行写锁" class="sidebar-link">行写锁</a></li></ul></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL锁.html#记录锁" class="sidebar-link">记录锁</a></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL锁.html#间隙锁" class="sidebar-link">间隙锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL锁.html#什么是间隙锁？" class="sidebar-link">什么是间隙锁？</a></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL锁.html#间隙锁锁住的范围" class="sidebar-link">间隙锁锁住的范围</a></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL锁.html#案例分析" class="sidebar-link">案例分析</a></li></ul></li><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL锁.html#死锁" class="sidebar-link">死锁</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/database/RDB/MySQL_Learn/MySQL锁.html#死锁解决方法" class="sidebar-link">死锁解决方法</a></li></ul></li></ul></li><li><a href="/database/RDB/MySQL_Learn/MySQL事务.html" class="sidebar-link">MySQL 事务</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="mysql-锁"><a href="#mysql-锁" class="header-anchor">#</a> MySQL 锁</h1> <p>MySQL 锁是实现事务的关键，因此需要学习 MySQL 的锁。</p> <h2 id="mysql-锁种类"><a href="#mysql-锁种类" class="header-anchor">#</a> MySQL 锁种类</h2> <p>在 MySQL 中，锁的种类图如下：</p> <p><img src="/mysql_img/locksort.jpg" alt="lock"></p> <p>重点讲解一下悲观锁中的表锁与行锁，乐观锁留在 <code>Redis</code> 讲解</p> <h2 id="表级锁种类"><a href="#表级锁种类" class="header-anchor">#</a> 表级锁种类</h2> <p>由图示可以看到，MySQL 表锁有三种：</p> <ul><li>表锁</li> <li>元数据（MDL）锁</li> <li>意向锁</li></ul> <p>其中，表锁和元数据锁都是 MySQL Layer 层提供的， 意向锁是由 InnoDB 提供的。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>首先需要明确一点的是，锁只是一种状态，共享读不是读，加了共享读锁的话，别的事务就不能对这个数据再加排它写锁。</p></div> <h3 id="查看锁表情况"><a href="#查看锁表情况" class="header-anchor">#</a> 查看锁表情况</h3> <p>可以通过 <code>show status like 'table%';</code> 来查看当前数据库中发生过多少次锁表现象</p> <p><img src="/mysql_img/checklock.png" alt="lock"></p> <p>其中：</p> <ul><li>table_locks_immediate：产生表级锁定的次数；</li> <li>table_locks_waited：出现表级锁定争用而发生等待的次数</li></ul> <h2 id="表级锁之表锁"><a href="#表级锁之表锁" class="header-anchor">#</a> 表级锁之表锁</h2> <h3 id="表锁的表现形式"><a href="#表锁的表现形式" class="header-anchor">#</a> 表锁的表现形式</h3> <p>表锁一共分为两种表现形式，分别是：</p> <ul><li>表共享读锁（Table Read Lock）</li> <li>表独占写锁（Table Write Lock）</li></ul> <h3 id="表锁的添加删除和查看"><a href="#表锁的添加删除和查看" class="header-anchor">#</a> 表锁的添加删除和查看</h3> <p>表锁是要手动添加的一种表级锁，通过关键字 <code>lock table 表名称 read(write),表名称2 read(write)</code> 添加读、写锁。</p> <p>如果想要查看表锁，可以通过 <code>show open tables;</code> 进行查看</p> <p>如果想要删除表锁，可以通过 <code>unlock tables;</code></p> <h3 id="表锁演示"><a href="#表锁演示" class="header-anchor">#</a> 表锁演示</h3> <p>准备工作：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">--新建表</span>
<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> mylock <span class="token punctuation">(</span>
id <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span> <span class="token keyword">AUTO_INCREMENT</span><span class="token punctuation">,</span>
NAME <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
<span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> mylock <span class="token punctuation">(</span>id<span class="token punctuation">,</span>NAME<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> mylock <span class="token punctuation">(</span>id<span class="token punctuation">,</span>NAME<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'b'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> mylock <span class="token punctuation">(</span>id<span class="token punctuation">,</span>NAME<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token string">'c'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">INSERT</span> <span class="token keyword">INTO</span> mylock <span class="token punctuation">(</span>id<span class="token punctuation">,</span>NAME<span class="token punctuation">)</span> <span class="token keyword">VALUES</span> <span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span> <span class="token string">'d'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><strong>演示读锁：</strong></p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token number">1</span>、session1: <span class="token keyword">lock</span> <span class="token keyword">table</span> mylock <span class="token keyword">read</span><span class="token punctuation">;</span> <span class="token comment">-- 给mylock表加读锁</span>
<span class="token number">2</span>、session1: <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> mylock<span class="token punctuation">;</span> <span class="token comment">-- 可以查询</span>
<span class="token number">3</span>、session1：<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tdep<span class="token punctuation">;</span> <span class="token comment">-- 不能访问非锁定表</span>
<span class="token number">4</span>、session2：<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> mylock<span class="token punctuation">;</span> <span class="token comment">-- 可以查询 没有锁</span>
<span class="token number">5</span>、session2：<span class="token keyword">update</span> mylock <span class="token keyword">set</span> name<span class="token operator">=</span><span class="token string">'x'</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">-- 修改阻塞,自动加行写锁</span>
<span class="token number">6</span>、session1：<span class="token keyword">unlock</span> <span class="token keyword">tables</span><span class="token punctuation">;</span> <span class="token comment">-- 释放表锁</span>
<span class="token number">7</span>、session2：<span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span> Changed: <span class="token number">1</span> <span class="token keyword">Warnings</span>: <span class="token number">0</span> <span class="token comment">-- 修改执行完成</span>
<span class="token number">8</span>、session1：<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tdep<span class="token punctuation">;</span> <span class="token comment">--可以访问</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>加了读锁，<code>session 1</code> 只能对锁住的表进行读，不能写，也不能读其它的表，<code>session 2</code> 可以读 <code>session 1</code> 锁住的表，但是不能写。因为写操作会自动加排他写锁，而排他写于共享读是冲突的。</p> <p><strong>演示写锁</strong>:</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token number">1</span>、session1: <span class="token keyword">lock</span> <span class="token keyword">table</span> mylock <span class="token keyword">write</span><span class="token punctuation">;</span> <span class="token comment">-- 给mylock表加写锁</span>
<span class="token number">2</span>、session1: <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> mylock<span class="token punctuation">;</span> <span class="token comment">-- 可以查询</span>
<span class="token number">3</span>、session1：<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tdep<span class="token punctuation">;</span> <span class="token comment">--不能访问非锁定表</span>
<span class="token number">4</span>、session1：<span class="token keyword">update</span> mylock <span class="token keyword">set</span> name<span class="token operator">=</span><span class="token string">'y'</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">--可以执行</span>
<span class="token number">5</span>、session2：<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> mylock<span class="token punctuation">;</span> <span class="token comment">-- 查询阻塞</span>
<span class="token number">6</span>、session1：<span class="token keyword">unlock</span> <span class="token keyword">tables</span><span class="token punctuation">;</span> <span class="token comment">-- 释放表锁</span>
<span class="token number">7</span>、session2：<span class="token number">4</span> <span class="token keyword">rows</span> <span class="token operator">in</span> <span class="token keyword">set</span> <span class="token punctuation">(</span><span class="token number">22.57</span> sec<span class="token punctuation">)</span> <span class="token comment">-- 查询执行完成</span>
<span class="token number">8</span>、session1：<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> tdep<span class="token punctuation">;</span> <span class="token comment">--可以访问</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>加了写锁，<code>session 1</code> 可以对锁住的表进行读或写，<code>session 2</code> 对 <code>session 1</code> 锁住的表，读都不能读，也就是说，表级的写锁是独享状态的，不与任何其它 session 分享。</p> <h2 id="表级锁之mdl锁"><a href="#表级锁之mdl锁" class="header-anchor">#</a> 表级锁之MDL锁</h2> <p><code>MDL</code>锁又称为元数据锁，是一种<strong style="color:#3EAF7C;">用来保护表结构的锁</strong>。它也分为两种表现形式：</p> <ul><li><code>MDL</code> 读锁</li> <li><code>MDL</code> 写锁</li></ul> <p>其中，<strong style="color:#3EAF7C;">当执行 <code>DML</code> 语句的时候，会自动添加 <code>MDL</code> 读锁，当执行 <code>DDL</code> 语句修改表结构的时候，会自动添加 <code>MDL</code> 写锁</strong>，也就是说，当我们在更新数据的时候，<code>DDL</code> 语句由于获取不到 <code>MDL</code> 写锁，所以是无法执行的。又当我们在执行 <code>DDL</code> 语句的时候，会添加 <code>MDL</code> 写锁，因此如果想要执行 <code>DML</code> 语句时，由于无法获取到 <code>DML</code> 读锁，也是无法执行的。</p> <p>这样就能够保证表结构在 CRUD 的时候不被影响。</p> <h3 id="mdl锁演示"><a href="#mdl锁演示" class="header-anchor">#</a> MDL锁演示</h3> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token number">1</span>、session1: <span class="token keyword">begin</span><span class="token punctuation">;</span><span class="token comment">--开启事务</span>
  <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> mylock<span class="token punctuation">;</span><span class="token comment">--加MDL读锁</span>
<span class="token number">2</span>、session2: <span class="token keyword">alter</span> <span class="token keyword">table</span> mylock <span class="token keyword">add</span> f <span class="token keyword">int</span><span class="token punctuation">;</span> <span class="token comment">-- 修改阻塞</span>
<span class="token number">3</span>、session1：<span class="token keyword">commit</span><span class="token punctuation">;</span> <span class="token comment">--提交事务 或者 rollback 释放读锁</span>
<span class="token number">4</span>、session2：Query OK<span class="token punctuation">,</span> <span class="token number">0</span> <span class="token keyword">rows</span> affected <span class="token punctuation">(</span><span class="token number">38.67</span> sec<span class="token punctuation">)</span>  <span class="token comment">--修改完成</span>
 Records: <span class="token number">0</span> Duplicates: <span class="token number">0</span> <span class="token keyword">Warnings</span>: <span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h2 id="表级锁之意向锁"><a href="#表级锁之意向锁" class="header-anchor">#</a> 表级锁之意向锁</h2> <p>意向锁是由存储引擎 <code>InnoDB</code> 实现的一种<strong style="color:#3EAF7C;">为了全表更新数据时的性能提升</strong>的表级锁，它由 MySQL 控制，不需要人为的去操控这个锁，它同样分为两种：</p> <ul><li>意向共享读（IS）：当打算给某一行数据添加一个<strong>行级别的共享读锁</strong>时，需要先获取到这个表的 <code>IS</code> 锁才可以</li> <li>意向排他写（IX）：当打算给某一行数据添加一个<strong>行级别的排他写锁</strong>时，需要先获取到这个表的 <code>IX</code> 锁才可以</li></ul> <h3 id="意向锁解决的问题"><a href="#意向锁解决的问题" class="header-anchor">#</a> 意向锁解决的问题</h3> <p>为什么要存在意向锁这么一个东西呢？先来看这样一个场景，假设现在 <code>Session A</code> 现在给 <code>user</code> 表中的某一行记录添加了一个 <code>行锁</code>，此时 <code>Session B</code> 想要给 <code>user</code> 表加一个表级 <code>X</code> 锁来批量修改数据，此时只有两种获取到表锁的机会：</p> <ul><li>判断表是否已被其他事务用表锁锁表</li> <li>逐行判断这个表中是否有哪一行被其他事物用行锁锁住</li></ul> <p>可以看到，第一种方式很容易就能判断出来，但是第二种方式要如何判断出是否有行锁呢？因此，InnoDB 引入了意向锁的概念，<strong style="color:#3EAF7C;">它规定了，当事务想要对表中记录添加行读/写锁之前，必须先申请到该表的意向读/写锁。</strong></p> <p>例如，<code>Session A</code> 现在想要给 <code>user</code> 表中的某一行记录添加 <code>行锁</code>，如果添加的是<code>行写锁</code>，则需要先申请到 <code>user</code> 的<code>意向排他写锁</code>，如果添加的是<code>行读锁</code>，则需要先申请到 <code>意向共享读锁</code>。</p> <p>这样，当 <code>Session B</code> 想要对 <code>user</code> 添加表级锁的时候，就可以先判断这个表当前是否存在 <code>意向锁</code> ，就可以知道现在表中是否有记录被添加了 <code>行锁</code> 了。</p> <h3 id="意向锁兼容图"><a href="#意向锁兼容图" class="header-anchor">#</a> 意向锁兼容图</h3> <p>这里是意向锁与<strong>表级锁</strong>之间的兼容图。</p> <p><img src="/mysql_img/yixiangsuo.jpg" alt="img"></p> <div class="custom-block tip"><p class="custom-block-title">注意</p> <p>注意，意向锁与行锁之间是没有冲突关系的，只是与表锁存在冲突关系。即 <code>IX</code>，<code>IS</code>是表级锁，不会和行级的<code>X</code>，<code>S</code>锁发生冲突。只会和表级的<code>X</code>，<code>S</code>发生冲突</p></div> <h2 id="行级锁"><a href="#行级锁" class="header-anchor">#</a> 行级锁</h2> <p>行级锁是在存储引擎层实现的一种粒度更小的锁，它是为了并发而存在的，以前在使用 <code>MyISAM</code> 存储引擎的时候，并不支持行级锁，因此如果想要做并发只能通过表级锁，换句话说，<strong style="color:#3EAF7C;">使用表级锁做并发就意味着同一时刻只能有一条 <code>DML</code> 语句在执行，其他的都得等待这个语句执行完成后才能执行</strong>。</p> <p>另外，行锁是通过给<strong style="color:#3EAF7C;">索引上的索引项</strong>加锁来实现的。这就意味着，只有通过索引进行条件检索的数据，<code>innodb</code> 才会给它加上行锁，否则将会升级为表锁！！！</p> <p>因此 <code>InnoDB</code> 开发了行级锁，行级锁按照锁定范围区分，可以划分为三种：</p> <ul><li>记录锁(Record Lock)，锁定表中的某一条记录, <strong style="color:#3EAF7C;">通常由等值主键条件产生</strong></li> <li>间隙锁（Gap Lock），锁定记录前、记录中、记录后的行 ，<strong style="color:#3EAF7C;">只在Mysql默认隔离级别RR下存在</strong></li> <li>Next Key锁: 记录锁 + 间隙锁</li></ul> <p>按照功能划分的话，可以划分为两种：</p> <ul><li>共享读锁</li> <li>排它写锁</li></ul> <h3 id="共享读和排他写"><a href="#共享读和排他写" class="header-anchor">#</a> 共享读和排他写</h3> <p>共享锁(S锁)又称读锁，若事务<code>T</code>对数据对象<code>A</code>加上<code>S</code>锁，则事务<code>T</code>可以读<code>A</code>但不能修改<code>A</code>，其他事务只能再对<code>A</code>加<code>S</code>锁，而不能加<code>X</code>锁，直到<code>T</code>释放<code>A</code>上的<code>S</code> 锁。这保证了其他事务可以读<code>A</code>，但在<code>T</code>释放<code>A</code>上的<code>S</code>锁之前不能对<code>A</code>做任何修改。</p> <p>排他锁(X锁)又称写锁。若事务<code>T</code>对数据对象<code>A</code>加上<code>X</code>锁，事务<code>T</code>可以读<code>A</code>也可以修改<code>A</code>，其他事务不能再对<code>A</code>加任何锁，直到<code>T</code>释放<code>A</code>上的锁。这保证了其他事务在<code>T</code>释放<code>A</code>上的锁之前不能再读取和修改<code>A</code>。</p> <h3 id="添加行锁"><a href="#添加行锁" class="header-anchor">#</a> 添加行锁</h3> <h4 id="添加共享读锁"><a href="#添加共享读锁" class="header-anchor">#</a> 添加共享读锁</h4> <p>共享读锁需要通过手动添加的方式来添加，当添加了共享读锁后，<strong style="color:#3EAF7C;">允许一个事务去读取一行记录，同时防止别的事务去添加排他写锁，对其进行更新操作</strong>。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> table_name <span class="token keyword">WHERE</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">LOCK</span> <span class="token operator">IN</span> <span class="token keyword">SHARE</span> <span class="token keyword">MODE</span>  <span class="token comment">-- 共享读锁 手动添加</span>
<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> <span class="token keyword">table</span>  <span class="token comment">-- 无锁</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h4 id="添加排他写锁"><a href="#添加排他写锁" class="header-anchor">#</a> 添加排他写锁</h4> <p>排他写锁允许获得该锁的事务对记录进行读取或修改，同时防止其它事务对其添加读锁或写锁</p> <div class="custom-block danger"><p class="custom-block-title">注意</p> <p>这里是防止其它事务对其添加读锁，并不是防止其它事务读取该条记录，读锁并不是读。</p></div> <p>它有两种添加方式，一种是自动添加，另一种是手动添加：</p> <ul><li><code>DML</code> 语句会自动添加排他写锁</li> <li>手动添加则通过关键字 <code>FOR UPDATE</code> 表示添加的是一个排他写锁</li></ul> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">SELECT</span> <span class="token operator">*</span> <span class="token keyword">FROM</span> table_name <span class="token keyword">WHERE</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token keyword">FOR</span> <span class="token keyword">UPDATE</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="查看行锁状态"><a href="#查看行锁状态" class="header-anchor">#</a> 查看行锁状态</h3> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">show</span> <span class="token keyword">STATUS</span> <span class="token operator">like</span> <span class="token string">'innodb_row_lock%'</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>几个指标的含义：</p> <ul><li>Innodb_row_lock_current_waits：当前正在等待锁定的数量；</li> <li>Innodb_row_lock_time：从系统启动到现在锁定总时间长度；</li> <li>Innodb_row_lock_time_avg：每次等待所花平均时间；</li> <li>Innodb_row_lock_time_max：从系统启动到现在等待最常的一次所花的时间；</li> <li>Innodb_row_lock_waits：系统启动后到现在总共等待的次数；</li></ul> <h3 id="两阶段锁提交"><a href="#两阶段锁提交" class="header-anchor">#</a> 两阶段锁提交</h3> <p>两阶段提交指的是，在一个事务中，处于加锁阶段时，只会加锁，等到事务提交后，进入解锁阶段，才会开始解锁。例如：</p> <p><img src="/mysql_img/2pc.png" alt="img"></p> <p>在这里，A 会给 <code>id=1/2</code> 的记录都加上锁，因此 B 会被阻塞，直到 A 提交了事务，锁才被释放。</p> <p>那么，两阶段提交这样子做有什么意义呢？目前我们知道了，在一个事务中，只不要提交事务，所加的锁都不会被释放，会一直被持有。设想下面这个场景：顾客 <code>userA</code> 要在影院购买电影票，需要涉及以下操作：</p> <ol><li>扣除顾客 userA 账户余额</li> <li>增加影院 cinema 账户余额</li> <li>记录一条交易日志</li></ol> <p>也就是说，完成这个交易，涉及到两个 <code>update</code> 和一个 <code>insert</code>，需要加三个行写锁。并且为了保证事务的原子性，我们必须将这三个操作放在一个事务中，换句话说，当我们提交这个事务之前，根据两阶段锁协议，这三个锁都不会被释放。</p> <p>假设现在顾客 <code>userB</code> 也要在影院购买电影票，这三个步骤同样也是需要加锁执行的，因此对于步骤2增加影院余额来说，两个事务就会发生等待锁的操作。因此可以利用两阶段锁，来降低事务等待锁的时间，因为无论怎么对三个步骤排序，锁都是会加上的，所以<strong style="color:#3EAF7C;">尽量让最可能造成锁冲突的、最可能影响并发度的锁往后放</strong>，即将步骤2放在事务的最后一步再做，图示如下：</p> <p><img src="/mysql_img/2pcdemo.jpg" alt="/mysql_img/"></p> <p>如果将<code>步骤2</code>放在最前面，则 <code>userB</code> 需要等待一整个 <code>userA</code> 的事务结束才能获取到锁。</p> <h2 id="行级锁演示"><a href="#行级锁演示" class="header-anchor">#</a> 行级锁演示</h2> <p>下面分别演示一下行锁的几种情况：</p> <ul><li>行读锁</li> <li>行写锁</li> <li>行读锁升级表锁</li></ul> <h3 id="行读锁"><a href="#行读锁" class="header-anchor">#</a> 行读锁</h3> <p>注意这里加锁的时候，使用的索引是主键索引</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token number">1</span>、session1: <span class="token keyword">begin</span><span class="token punctuation">;</span><span class="token comment">--开启事务未提交</span>
             <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> mylock  <span class="token keyword">where</span> ID<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">lock</span> <span class="token operator">in</span> <span class="token keyword">share</span> <span class="token keyword">mode</span><span class="token punctuation">;</span> <span class="token comment">--手动加id=1的行读锁,使用索引</span>
<span class="token number">2</span>、session2：<span class="token keyword">update</span> mylock <span class="token keyword">set</span> name<span class="token operator">=</span><span class="token string">'y'</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">-- 未锁定该行可以修改</span>
<span class="token number">3</span>、session2：<span class="token keyword">update</span> mylock <span class="token keyword">set</span> name<span class="token operator">=</span><span class="token string">'y'</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">-- 锁定该行修改阻塞</span>
             ERROR <span class="token number">1205</span> <span class="token punctuation">(</span>HY000<span class="token punctuation">)</span>: <span class="token keyword">Lock</span> wait timeout exceeded<span class="token punctuation">;</span> try restarting <span class="token keyword">transaction</span> <span class="token comment">-- 锁定超时</span>
<span class="token number">4</span>、session1: <span class="token keyword">commit</span><span class="token punctuation">;</span> <span class="token comment">--提交事务 或者 rollback 释放读锁</span>
<span class="token number">5</span>、session2：<span class="token keyword">update</span> mylock <span class="token keyword">set</span> name<span class="token operator">=</span><span class="token string">'y'</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">--修改成功</span>
             Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
             <span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span> Changed: <span class="token number">1</span> <span class="token keyword">Warnings</span>: <span class="token number">0</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="行读锁升级表锁"><a href="#行读锁升级表锁" class="header-anchor">#</a> 行读锁升级表锁</h3> <p>当我们加锁的查询条件不是索引时，由于不是索引，因此需要进行全表扫描，所以会逐行加锁，也就是直到事务被提交，行锁由于被逐行遍历，会相当于锁了整张表，变为表锁。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token number">1</span>、session1: <span class="token keyword">begin</span><span class="token punctuation">;</span><span class="token comment">--开启事务未提交</span>
             <span class="token comment">--手动加name='c'的行读锁,未使用索引</span>
             <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> mylock  <span class="token keyword">where</span> name<span class="token operator">=</span><span class="token string">'c'</span> <span class="token keyword">lock</span> <span class="token operator">in</span> <span class="token keyword">share</span> <span class="token keyword">mode</span><span class="token punctuation">;</span>
<span class="token number">2</span>、session2：<span class="token keyword">update</span> mylock <span class="token keyword">set</span> name<span class="token operator">=</span><span class="token string">'y'</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">-- 修改阻塞 未用索引行锁升级为表锁</span>
<span class="token number">3</span>、session1: <span class="token keyword">commit</span><span class="token punctuation">;</span> <span class="token comment">--提交事务 或者 rollback 释放读锁</span>
<span class="token number">4</span>、session2：<span class="token keyword">update</span> mylock <span class="token keyword">set</span> name<span class="token operator">=</span><span class="token string">'y'</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">--修改成功</span>
             Query OK<span class="token punctuation">,</span> <span class="token number">1</span> <span class="token keyword">row</span> affected <span class="token punctuation">(</span><span class="token number">0.00</span> sec<span class="token punctuation">)</span>
             <span class="token keyword">Rows</span> <span class="token keyword">matched</span>: <span class="token number">1</span> Changed: <span class="token number">1</span> <span class="token keyword">Warnings</span>: 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h3 id="行写锁"><a href="#行写锁" class="header-anchor">#</a> 行写锁</h3> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token number">1</span>、session1: <span class="token keyword">begin</span><span class="token punctuation">;</span><span class="token comment">--开启事务未提交</span>
      <span class="token comment">--手动加id=1的行写锁,</span>
      <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> mylock  <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">for</span> <span class="token keyword">update</span><span class="token punctuation">;</span>
     
<span class="token number">2</span>、session2：<span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> mylock  <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">2</span> <span class="token punctuation">;</span> <span class="token comment">-- 可以访问</span>
<span class="token number">3</span>、session2: <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> mylock  <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span> <span class="token punctuation">;</span> <span class="token comment">-- 可以读 不加锁 </span>
  <span class="token number">4</span>、session2: <span class="token keyword">select</span> <span class="token operator">*</span> <span class="token keyword">from</span> mylock  <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span> <span class="token keyword">lock</span> <span class="token operator">in</span> <span class="token keyword">share</span> <span class="token keyword">mode</span> <span class="token punctuation">;</span> <span class="token comment">-- 加读锁</span>
被阻塞
<span class="token number">5</span>、session1：<span class="token keyword">commit</span><span class="token punctuation">;</span> <span class="token comment">-- 提交事务 或者 rollback 释放写锁</span>
<span class="token number">5</span>、session2：执行成功
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h2 id="记录锁"><a href="#记录锁" class="header-anchor">#</a> 记录锁</h2> <p>以上几种情况通过使用<strong style="color:#3EAF7C;">主键等值条件或唯一索引等值条件</strong>产生的锁，都称为记录锁。</p> <h2 id="间隙锁"><a href="#间隙锁" class="header-anchor">#</a> 间隙锁</h2> <p>间隙锁是一种<strong style="color:#3EAF7C;">用来防止幻读</strong>的锁，例如下面这个图，如果没有间隙锁的保护，让事务 B 插入了数据，则事务 A 两次读到的数据就不一样了。</p> <p><img src="/mysql_img/huandu.png" alt="HUANDU"></p> <p>不过要注意的是，<strong style="color:#3EAF7C;">间隙锁只在隔离级别为可重复读 RR 的情况下产生，因为幻读就是在这个级别下的问题</strong>。</p> <h3 id="什么是间隙锁？"><a href="#什么是间隙锁？" class="header-anchor">#</a> 什么是间隙锁？</h3> <p>事务加锁后锁住的是表记录的某一个区间，当表的相邻ID之间出现空隙则会形成一个区间，特点是左闭右开，这个被锁住的区间就是间隙锁。间隙锁防止两种情况发生：</p> <ul><li>1、防止插入间隙内的数据</li> <li>2、防止已有数据更新为间隙内的数据</li></ul> <h3 id="间隙锁锁住的范围"><a href="#间隙锁锁住的范围" class="header-anchor">#</a> 间隙锁锁住的范围</h3> <p>案例demo：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code>案例演示：
<span class="token keyword">create</span> <span class="token keyword">table</span> news <span class="token punctuation">(</span>id <span class="token keyword">int</span><span class="token punctuation">,</span> number <span class="token keyword">int</span><span class="token punctuation">,</span><span class="token keyword">primary</span> <span class="token keyword">key</span> <span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> news <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> news <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> news <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> news <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> news <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> news <span class="token keyword">values</span><span class="token punctuation">(</span><span class="token number">13</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">-- 加非唯一索引</span>
<span class="token keyword">alter</span> <span class="token keyword">table</span> news <span class="token keyword">add</span> <span class="token keyword">index</span> idx_num<span class="token punctuation">(</span>number<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>例如存在如下 SQL ：</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token keyword">update</span> news <span class="token keyword">set</span> number<span class="token operator">=</span><span class="token number">3</span> <span class="token keyword">where</span> number<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>当在事务中执行该语句后，根据上面间隙锁的含义，可得锁住的范围是：Id[1,6]、Number[2,5],因此如果要插入或更新数据，有以下几个情况：</p> <ul><li>id、number均在间隙外，例如 （7，1）</li> <li>id、number均在间隙内，例如（2，2）</li> <li>id在间隙内、number在间隙外，例如（2，6）</li> <li>id在间隙外，number在间隙内，例如（7，3）</li> <li>id在间隙外，number为上边缘数据，例如（7，2）</li> <li>id在间隙内，number为上边缘数据，例如（2，2）</li> <li>id在间隙外，number为下边缘数据，例如（7，5）</li> <li>id在间隙内，number为下边缘数据，例如（4，5）</li></ul> <h3 id="案例分析"><a href="#案例分析" class="header-anchor">#</a> 案例分析</h3> <p><strong>非唯一索引等值更新</strong></p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">-- 非唯一索引的等值</span>
<span class="token keyword">session</span> <span class="token number">1</span>:
<span class="token keyword">start</span> <span class="token keyword">transaction</span> <span class="token punctuation">;</span>
<span class="token keyword">update</span> news <span class="token keyword">set</span> number<span class="token operator">=</span><span class="token number">3</span> <span class="token keyword">where</span> number<span class="token operator">=</span><span class="token number">4</span><span class="token punctuation">;</span>
<span class="token keyword">session</span> <span class="token number">2</span>:
<span class="token keyword">start</span> <span class="token keyword">transaction</span> <span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> news <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">#（均在间隙内，阻塞）</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> news <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">#（均在间隙外，成功）</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> news <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">#（id在间隙内，number在间隙外，成功）</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> news <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">#（id在间隙内，number在间隙外，成功）</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> news <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">#（id在间隙外，number在间隙内，阻塞）</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> news <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment"># (id在间隙外，number为上边缘数据，阻塞)</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> news <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">#（id在间隙内，number为上边缘数据，阻塞）</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> news <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">#（id在间隙外，number为下边缘数据，成功）</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> news <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">#（id在间隙内，number为下边缘数据，阻塞）</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>图示：</p> <p><img src="/mysql_img/gailock.jpg" alt="img"></p> <p>结论：只要 <code>number</code> 处于区间[2,5)内的数据，即[上边缘，下边缘)，无论 id 是否在间隙内，都会堵塞。如果 <code>number</code> 是下边缘数据，id 情况是<code>外通内堵</code>。</p> <p><strong>主键索引范围</strong></p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">--主键索引范围</span>
<span class="token keyword">session</span> <span class="token number">1</span>:
<span class="token keyword">start</span> <span class="token keyword">transaction</span> <span class="token punctuation">;</span>
<span class="token keyword">update</span> news <span class="token keyword">set</span> number<span class="token operator">=</span><span class="token number">3</span> <span class="token keyword">where</span> id<span class="token operator">&gt;</span><span class="token number">1</span> <span class="token operator">and</span> id <span class="token operator">&lt;</span><span class="token number">6</span><span class="token punctuation">;</span>
<span class="token keyword">session</span> <span class="token number">2</span>:
<span class="token keyword">start</span> <span class="token keyword">transaction</span> <span class="token punctuation">;</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> news <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">#（id在间隙内，number在间隙内，阻塞）</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> news <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">#（id在间隙内，number在间隙外，阻塞）</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> news <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">#（id在间隙内，number在间隙外，阻塞）</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> news <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">#（id在间隙外，number在间隙外，成功）</span>
<span class="token keyword">insert</span> <span class="token keyword">into</span> news <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token number">7</span><span class="token punctuation">,</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">#（id在间隙外，number在间隙内，成功）</span>
<span class="token comment">--id无边缘数据，因为主键不能重复</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>结论：只要主键 <code>id</code> 处于（2,4,5）范围内，无论 <code>number</code> 是多少都会堵塞</p> <p><strong>非唯一索引无穷大/小</strong></p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token comment">--无穷大</span>
<span class="token keyword">session</span> <span class="token number">1</span>:
  <span class="token keyword">start</span> <span class="token keyword">transaction</span> <span class="token punctuation">;</span>
  <span class="token keyword">update</span> news <span class="token keyword">set</span> number<span class="token operator">=</span><span class="token number">3</span> <span class="token keyword">where</span> number<span class="token operator">=</span><span class="token number">13</span> <span class="token punctuation">;</span> <span class="token comment">-- 并不存在 number = 13</span>
<span class="token keyword">session</span> <span class="token number">2</span>:
  <span class="token keyword">start</span> <span class="token keyword">transaction</span> <span class="token punctuation">;</span>
  <span class="token keyword">insert</span> <span class="token keyword">into</span> news <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">,</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">#(id在间隙外，number在间隙外，成功)</span>
  <span class="token keyword">insert</span> <span class="token keyword">into</span> news <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token number">12</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">#(id在间隙外，number为上边缘数据，成功)</span>
  <span class="token keyword">insert</span> <span class="token keyword">into</span> news <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token number">14</span><span class="token punctuation">,</span><span class="token number">11</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">#(id在间隙内，number为上边缘数据，阻塞)</span>
  <span class="token keyword">insert</span> <span class="token keyword">into</span> news <span class="token keyword">value</span><span class="token punctuation">(</span><span class="token number">15</span><span class="token punctuation">,</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">#(均在间隙内，阻塞)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>也就是说，非主键索引无论是等值还是范围查询都会产生间隙锁，主键只有范围查询才会产生间隙锁</p> <h2 id="死锁"><a href="#死锁" class="header-anchor">#</a> 死锁</h2> <p>死锁是互相等待对方释放资源，又互相占据着对方的资源而产生的，例如：</p> <p><img src="/mysql_img/deadlock.jpg" alt="dead"></p> <p>事务 A 占据了 <code>id=1</code> 的写锁，又想申请 <code>id=2</code> 的锁，事务 B 占据了 <code>id=2</code> 的写锁，又想申请 <code>id=1</code> 的锁，因此最终谁也无得得到锁，形成了死锁。</p> <div class="language-sql line-numbers-mode"><pre class="language-sql"><code><span class="token number">1</span>、session1: <span class="token keyword">begin</span><span class="token punctuation">;</span><span class="token comment">--开启事务未提交</span>
             <span class="token comment">--手动加行写锁 id=1 ，使用索引</span>
             <span class="token keyword">update</span> mylock <span class="token keyword">set</span> name<span class="token operator">=</span><span class="token string">'m'</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span>
<span class="token number">2</span>、session2：<span class="token keyword">begin</span><span class="token punctuation">;</span><span class="token comment">--开启事务未提交</span>
             <span class="token comment">--手动加行写锁 id=2 ，使用索引</span>
             <span class="token keyword">update</span> mylock <span class="token keyword">set</span> name<span class="token operator">=</span><span class="token string">'m'</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span>
<span class="token number">3</span>、session1: <span class="token keyword">update</span> mylock <span class="token keyword">set</span> name<span class="token operator">=</span><span class="token string">'nn'</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">2</span><span class="token punctuation">;</span> <span class="token comment">-- 加写锁被阻塞</span>
<span class="token number">4</span>、session2：<span class="token keyword">update</span> mylock <span class="token keyword">set</span> name<span class="token operator">=</span><span class="token string">'nn'</span> <span class="token keyword">where</span> id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">-- 加写锁会死锁，不允许操作</span>
             ERROR <span class="token number">1213</span> <span class="token punctuation">(</span><span class="token number">40001</span><span class="token punctuation">)</span>: Deadlock found <span class="token keyword">when</span> trying <span class="token keyword">to</span> get <span class="token keyword">lock</span><span class="token punctuation">;</span> try restarting <span class="token keyword">transaction</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="死锁解决方法"><a href="#死锁解决方法" class="header-anchor">#</a> 死锁解决方法</h3> <ul><li>一种策略是，直接进入等待，直到超时。这个超时时间可以通过参数 <code>innodb_lock_wait_timeout</code> 来设置，默认是 50s。</li> <li>另一种策略是，发起死锁检测，发现死锁后，主动回滚死锁链条中的某一个事务，让其他事务得以继续执行。将参数 <code>innodb_deadlock_detect</code> 设置为 on，表示开启这个逻辑。</li></ul></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">更新时间:</span> <span class="time">2020-3-18 2:17:51 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/database/RDB/MySQL_Learn/MySQL索引详细分析.html" class="prev">
        MySQL 索引详细分析
      </a></span> <span class="next"><a href="/database/RDB/MySQL_Learn/MySQL事务.html">
        MySQL 事务
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.78cba7d9.js" defer></script><script src="/assets/js/2.b97de27f.js" defer></script><script src="/assets/js/12.da1eaab3.js" defer></script>
  </body>
</html>
